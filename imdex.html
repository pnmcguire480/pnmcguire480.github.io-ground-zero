<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Ground Zero">
<meta name="theme-color" content="#0d0c0a">
<meta name="description" content="AI-powered zombie apocalypse survival RPG. Build your own apocalypse, survive with dice rolls, and let AI narrate your story.">
<title>Ground Zero</title>
<link rel="apple-touch-icon" href="data:image/png;base64,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">
<link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiR3JvdW5kIFplcm8iLCJzaG9ydF9uYW1lIjoiR3JvdW5kIFplcm8iLCJkZXNjcmlwdGlvbiI6IkFJLXBvd2VyZWQgem9tYmllIGFwb2NhbHlwc2Ugc3Vydml2YWwgUlBHIiwic3RhcnRfdXJsIjoiLiIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiMwZDBjMGEiLCJ0aGVtZV9jb2xvciI6IiMwZDBjMGEiLCJpY29ucyI6W3sic3JjIjoiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCA1MTIgNTEyJyUzRSUzQ3JlY3Qgd2lkdGg9JzUxMicgaGVpZ2h0PSc1MTInIGZpbGw9JyUyMzBkMGMwYSclMkYlM0UlM0N0ZXh0IHg9JzUwJTI1JyB5PSc1MCUyNScgZG9taW5hbnQtYmFzZWxpbmU9J2NlbnRyYWwnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGZvbnQtc2l6ZT0nMzIwJyUzRSVGMCU5RiU5MiU4MCUzQyUyRnRleHQlM0UlM0MlMkZzdmclM0UiLCJzaXplcyI6IjUxMng1MTIiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCIsInB1cnBvc2UiOiJhbnkgbWFza2FibGUifV19">
<style>
:root{--bg-deep:#0d0c0a;--bg-panel:#1e1b16;--bg-card:#252118;--bg-hover:#2e2a22;--bg-active:#3a3428;--text-primary:#d4c8b0;--text-secondary:#9a8e7a;--text-dim:#5a5244;--accent-red:#a63d2f;--accent-red-glow:#c44a3a;--accent-green:#4a7a3a;--accent-amber:#b8952f;--accent-blue:#3a6a8a;--accent-purple:#6a4a8a;--accent-teal:#3a7a7a;--border:#2a2620}
*{box-sizing:border-box;margin:0;padding:0}html,body{height:100%;overflow:hidden}
body{background:var(--bg-deep);color:var(--text-primary);font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;font-size:14px;line-height:1.5;-webkit-tap-highlight-color:transparent}
.screen{display:none;height:100vh;height:100dvh;overflow-y:auto;flex-direction:column}.screen.active{display:flex}
@keyframes fadeIn{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
@keyframes diceAnim{0%{transform:scale(.5);opacity:0}50%{transform:scale(1.2)}100%{transform:scale(1);opacity:1}}
@keyframes pulseGlow{0%,100%{box-shadow:0 0 8px rgba(166,61,47,.3)}50%{box-shadow:0 0 20px rgba(166,61,47,.6)}}
@keyframes slideIn{from{opacity:0;transform:translateX(-20px)}to{opacity:1;transform:translateX(0)}}
@keyframes spinner{to{transform:rotate(360deg)}}
@keyframes slotSpin{0%{transform:translateY(-100%);opacity:0}50%{transform:translateY(0);opacity:1}100%{transform:translateY(0);opacity:1}}
@keyframes shakeHit{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
.fade-in{animation:fadeIn .4s ease-out}
.btn{background:var(--accent-red);color:#fff;border:none;padding:12px 28px;border-radius:6px;font-size:15px;font-weight:600;letter-spacing:1px;text-transform:uppercase;cursor:pointer;font-family:inherit;-webkit-appearance:none;transition:all .2s}
.btn:hover{background:var(--accent-red-glow)}.btn:active{transform:scale(.98)}.btn:disabled{opacity:.4;pointer-events:none}
.btn-sm{padding:8px 16px;font-size:12px}
.btn-ghost{background:0 0;color:var(--text-secondary);border:1px solid var(--border);padding:8px 16px;border-radius:6px;font-size:12px;font-weight:500;letter-spacing:1px;text-transform:uppercase;cursor:pointer;font-family:inherit;transition:all .2s}
.btn-ghost:hover{border-color:var(--text-secondary);background:var(--bg-hover)}
.btn-green{background:var(--accent-green);color:#fff;border:none;padding:12px 28px;border-radius:6px;font-size:15px;font-weight:600;letter-spacing:1px;text-transform:uppercase;cursor:pointer;font-family:inherit;transition:all .2s}
.btn-green:hover{background:#5a9a4a}
.card{border:1px solid var(--border);background:var(--bg-card);border-radius:8px;padding:12px;cursor:pointer;transition:all .2s}
.card.sel{border-color:var(--accent-red);background:var(--bg-active)}.card:hover{background:var(--bg-hover)}
.input{background:var(--bg-deep);border:1px solid var(--border);color:var(--text-primary);padding:10px 14px;border-radius:6px;font-size:14px;width:100%;outline:0;font-family:inherit;-webkit-appearance:none;transition:border-color .2s}
.input:focus{border-color:var(--accent-amber)}select.input{cursor:pointer}
.mono{font-family:'SF Mono',Menlo,Consolas,monospace}.serif{font-family:Georgia,'Times New Roman',serif}
.dim{color:var(--text-dim)}.sec{color:var(--text-secondary)}
.bar-track{height:5px;background:var(--bg-deep);border-radius:3px;overflow:hidden}.bar-fill{height:100%;border-radius:3px;transition:width .4s}
.grid{display:grid;gap:8px}
.mb-4{margin-bottom:4px}.mb-8{margin-bottom:8px}.mb-12{margin-bottom:12px}.mb-16{margin-bottom:16px}.mb-24{margin-bottom:24px}
.theme-tabs{display:flex;gap:2px;background:var(--bg-deep);border-radius:8px;padding:3px;margin-bottom:16px}
.theme-tab{flex:1;padding:10px 8px;border:none;background:transparent;color:var(--text-dim);font-size:12px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;cursor:pointer;border-radius:6px;font-family:inherit;transition:all .2s;text-align:center}
.theme-tab.active{background:var(--accent-red);color:#fff}.theme-tab:hover:not(.active){color:var(--text-secondary);background:var(--bg-hover)}
.theme-panel{display:none}.theme-panel.active{display:block}
.builder-cat{border:1px solid var(--border);border-radius:8px;margin-bottom:8px;overflow:hidden;transition:all .2s}
.builder-cat.open{border-color:var(--accent-amber)}
.builder-header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;cursor:pointer;background:var(--bg-card);transition:background .2s}
.builder-header:hover{background:var(--bg-hover)}
.builder-body{display:none;padding:12px 14px;border-top:1px solid var(--border);background:var(--bg-panel);animation:fadeIn .3s ease-out}
.builder-cat.open .builder-body{display:block}
.builder-cat .chevron{transition:transform .2s;color:var(--text-dim);font-size:12px}
.builder-cat.open .chevron{transform:rotate(90deg)}
.builder-tag{display:inline-block;padding:4px 10px;border-radius:4px;font-size:11px;border:1px solid var(--border);background:var(--bg-card);cursor:pointer;transition:all .2s;margin:2px}
.builder-tag.sel{border-color:var(--accent-red);background:var(--bg-active);color:var(--accent-red-glow)}.builder-tag:hover{border-color:var(--text-dim)}
.range-wrap{padding:4px 0}.range-wrap input[type=range]{width:100%;accent-color:var(--accent-red);height:4px}
.range-labels{display:flex;justify-content:space-between;font-size:10px;color:var(--text-dim);margin-top:4px}
.range-val{text-align:center;font-size:13px;font-weight:600;color:var(--accent-amber);margin-top:4px}
.preset-card{border:1px solid var(--border);background:var(--bg-card);border-radius:8px;padding:14px;cursor:pointer;transition:all .2s;border-left:3px solid transparent;position:relative;overflow:hidden}
.preset-card.sel{border-color:var(--accent-red);background:var(--bg-active)}.preset-card:hover{background:var(--bg-hover)}
.preset-card .source-badge{display:inline-block;font-size:9px;padding:2px 6px;border-radius:3px;background:var(--bg-deep);color:var(--text-dim);letter-spacing:.5px;text-transform:uppercase;margin-left:6px}
.preset-filter-bar{display:flex;gap:4px;flex-wrap:wrap;margin-bottom:12px}
.preset-filter{padding:5px 12px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--text-dim);font-size:11px;cursor:pointer;font-family:inherit;transition:all .2s}
.preset-filter.active{border-color:var(--accent-amber);color:var(--accent-amber);background:rgba(184,149,47,.1)}
.summary-panel{background:var(--bg-card);border:1px solid var(--border);border-radius:8px;padding:14px;margin-top:12px}
.summary-row{display:flex;justify-content:space-between;padding:4px 0;font-size:12px;border-bottom:1px solid var(--border)}.summary-row:last-child{border-bottom:none}
.summary-label{color:var(--text-dim)}.summary-value{color:var(--accent-amber);font-weight:500}
#game-screen .top-bar{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:var(--bg-panel);border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap;gap:4px}
#narrative-scroll{flex:1;overflow-y:auto;padding:16px;-webkit-overflow-scrolling:touch}
#action-panel{border-top:1px solid var(--border);padding:8px 12px;background:var(--bg-panel);flex-shrink:0}
#sidebar-overlay{display:none;background:var(--bg-panel);border-bottom:1px solid var(--border);max-height:50vh;overflow-y:auto;padding:12px}
#sidebar-overlay.open{display:block}
.action-btn{background:var(--bg-card);border:1px solid var(--border);border-radius:6px;padding:7px 10px;cursor:pointer;text-align:left;color:var(--text-primary);font-size:12px;font-family:inherit;width:100%;transition:all .2s}
.action-btn:hover{border-color:var(--accent-amber)}.action-btn:active{background:var(--bg-hover)}
.spin-icon{display:inline-block;width:20px;height:20px;border:3px solid var(--border);border-top-color:var(--accent-amber);border-radius:50%;animation:spinner .8s linear infinite}
.confirm-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:flex;justify-content:center;align-items:center;z-index:100}
.confirm-box{background:var(--bg-panel);border:1px solid var(--border);border-radius:10px;padding:24px;max-width:340px;text-align:center;width:90%}
.hud-btn{background:var(--bg-card);border:1px solid var(--border);color:var(--text-secondary);padding:3px 8px;border-radius:4px;font-size:10px;cursor:pointer;font-family:inherit;transition:all .2s}
.hud-btn:hover{border-color:var(--text-secondary)}
.tab-btn{background:0 0;border:1px solid var(--border);color:var(--text-dim);padding:4px 10px;border-radius:4px;font-size:11px;cursor:pointer;text-transform:uppercase;font-family:inherit;transition:all .2s}
.tab-btn.active{background:var(--bg-active);border-color:var(--accent-red);color:var(--text-primary)}
.slot-result{animation:slotSpin .4s ease-out;display:flex;justify-content:space-between;padding:8px 12px;background:var(--bg-card);border-radius:6px;margin-bottom:6px;border-left:3px solid var(--accent-amber)}
.roll-btn{background:linear-gradient(135deg,var(--accent-red),#8a2a20);padding:16px 40px;font-size:18px;border-radius:8px;animation:pulseGlow 2s infinite}.roll-btn:hover{animation:none;background:var(--accent-red-glow)}
/* Combat */
.combat-overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:90;display:flex;flex-direction:column;overflow-y:auto}
.combat-card{background:var(--bg-panel);border:1px solid var(--border);border-radius:8px;padding:16px;margin:8px;max-width:500px;width:calc(100% - 16px);align-self:center}
.enemy-card{background:var(--bg-card);border:1px solid var(--accent-red);border-radius:8px;padding:12px;margin-bottom:8px}
.combat-log-entry{padding:6px 10px;background:var(--bg-deep);border-radius:4px;margin-bottom:4px;font-size:12px;border-left:3px solid var(--border);animation:fadeIn .3s}
.combat-log-entry.hit{border-left-color:var(--accent-red)}.combat-log-entry.miss{border-left-color:var(--text-dim)}.combat-log-entry.crit{border-left-color:var(--accent-amber)}
.shake{animation:shakeHit .3s ease-out}
/* Travel */
.travel-panel{background:var(--bg-card);border:1px solid var(--accent-blue);border-radius:8px;padding:14px;margin-bottom:8px}
.zone-pick{padding:8px 12px;background:var(--bg-deep);border-radius:6px;margin-bottom:4px;cursor:pointer;border:1px solid var(--border);transition:all .2s}
.zone-pick:hover{border-color:var(--accent-blue)}.zone-pick.sel{border-color:var(--accent-amber);background:var(--bg-active)}
/* Save */
.save-slot{padding:12px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;margin-bottom:8px;cursor:pointer;transition:all .2s}
.save-slot:hover{border-color:var(--accent-amber)}.save-slot.has-data{border-left:3px solid var(--accent-green)}
/* Debug */
#debug-panel{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--bg-panel);border-top:2px solid var(--accent-purple);max-height:40vh;overflow-y:auto;z-index:200;padding:12px;font-size:11px}
#debug-panel.open{display:block}
.debug-btn{background:var(--accent-purple);color:#fff;border:none;padding:4px 8px;border-radius:4px;font-size:10px;cursor:pointer;font-family:inherit;margin:2px}
/* XP bar */
.xp-bar{height:3px;background:var(--bg-deep);border-radius:2px;overflow:hidden;margin-top:2px}.xp-fill{height:100%;background:var(--accent-amber);border-radius:2px;transition:width .3s}
/* Scrollbar */
::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:var(--bg-deep)}::-webkit-scrollbar-thumb{background:var(--border);border-radius:2px}
</style>
</head>
<body>

<!-- TITLE SCREEN -->
<div id="title-screen" class="screen active fade-in">
<div style="flex:1;display:flex;flex-direction:column;justify-content:center;align-items:center;padding:24px;text-align:center">
<div style="font-size:48px;margin-bottom:12px;opacity:.4">üíÄ</div>
<h1 style="font-size:clamp(32px,8vw,56px);font-weight:700;letter-spacing:4px;line-height:1;margin-bottom:8px">GROUND ZERO</h1>
<p class="serif" style="font-size:15px;color:var(--text-dim);font-style:italic;margin-bottom:40px;max-width:340px;line-height:1.6">Choose YOUR own apocalypse!</p>
<button class="btn" onclick="go('theme')" style="padding:16px 48px;font-size:17px">NEW GAME</button>
<button class="btn-green" id="continue-btn" onclick="showLoadScreen()" style="display:none;padding:14px 40px;font-size:15px;margin-top:12px">CONTINUE ‚ñ∂</button>
<div style="margin-top:24px;display:flex;gap:8px;flex-wrap:wrap;justify-content:center">
<button class="btn-ghost" style="font-size:10px;padding:6px 12px" onclick="showLoadScreen()">üìÇ LOAD</button>
<button class="btn-ghost" style="font-size:10px;padding:6px 12px" onclick="showImportDialog()">üìã IMPORT</button>
<button class="btn-ghost" id="install-btn" style="display:none;font-size:10px;padding:6px 12px" onclick="installPWA()">üì± INSTALL APP</button>
</div>
<p class="mono" style="margin-top:48px;font-size:10px;color:var(--text-dim);letter-spacing:2px">v1.0.0.4</p>
</div></div>

<!-- THEME SCREEN -->
<div id="theme-screen" class="screen" style="padding:20px">
<div class="fade-in mb-12">
<div class="mono dim mb-4" style="font-size:10px">STEP 1 OF 4</div>
<div class="bar-track mb-12" style="height:3px"><div class="bar-fill" style="width:25%;background:var(--accent-red)"></div></div>
<h2 style="font-size:22px;font-weight:700;letter-spacing:2px;margin-bottom:4px">CHOOSE YOUR APOCALYPSE</h2>
<p class="sec" style="font-size:13px;margin-bottom:12px">Pick a preset, build from scratch, or let chaos decide.</p>
</div>
<div class="theme-tabs">
<button class="theme-tab active" onclick="switchThemeTab('presets')">üé¨ Presets</button>
<button class="theme-tab" onclick="switchThemeTab('create')">‚öôÔ∏è Create</button>
<button class="theme-tab" onclick="switchThemeTab('random')">üé≤ Random</button>
</div>
<div id="tab-presets" class="theme-panel active" style="flex:1;overflow-y:auto;padding-bottom:72px">
<div class="preset-filter-bar" id="preset-filters"></div>
<div id="preset-list" class="grid"></div>
</div>
<div id="tab-create" class="theme-panel" style="flex:1;overflow-y:auto;padding-bottom:72px">
<div style="padding:8px 12px;background:var(--bg-panel);border:1px solid var(--accent-amber);border-radius:8px;margin-bottom:12px">
<div style="font-size:13px;color:var(--accent-amber);font-weight:600;margin-bottom:4px">üß¨ APOCALYPSE ARCHITECT</div>
<div style="font-size:11px;color:var(--text-secondary);line-height:1.5">20 categories drawn from every zombie franchise ever made. Build your nightmare one slider at a time.</div>
</div>
<div id="builder-cats"></div>
<div id="build-summary" class="summary-panel" style="display:none">
<div class="mono dim mb-8" style="font-size:10px;letter-spacing:2px">YOUR APOCALYPSE</div>
<div id="summary-rows"></div>
</div>
</div>
<div id="tab-random" class="theme-panel" style="flex:1;overflow-y:auto;padding-bottom:72px;text-align:center">
<div style="padding:40px 20px">
<div style="font-size:64px;margin-bottom:16px">üé∞</div>
<h3 style="font-size:20px;font-weight:700;letter-spacing:2px;margin-bottom:8px">FATE'S APOCALYPSE</h3>
<p class="serif sec" style="font-size:14px;margin-bottom:24px;line-height:1.6;max-width:320px;margin-left:auto;margin-right:auto">Every category randomized from the complete database. You don't choose the apocalypse ‚Äî it chooses you.</p>
<button class="btn roll-btn" onclick="rollRandomApocalypse()">üé≤ ROLL THE DICE</button>
</div>
<div id="random-results" style="text-align:left;padding:0 4px"></div>
</div>
<div style="padding:12px 0;background:var(--bg-deep);display:flex;justify-content:flex-end;flex-shrink:0">
<button class="btn" id="theme-next" disabled onclick="themeNext()">CONTINUE ‚Üí</button>
</div>
</div>

<!-- DIFFICULTY SCREEN -->
<div id="diff-screen" class="screen" style="padding:20px">
<div class="fade-in mb-16">
<button class="btn-ghost btn-sm mb-8" onclick="go('theme')">‚Üê BACK</button>
<div class="mono dim mb-4" style="font-size:10px">STEP 2 OF 4</div>
<div class="bar-track mb-12" style="height:3px"><div class="bar-fill" style="width:50%;background:var(--accent-red)"></div></div>
<h2 style="font-size:22px;font-weight:700;letter-spacing:2px;margin-bottom:4px">SET THE STAKES</h2>
<p class="sec" style="font-size:13px">How brutal should this world be?</p>
</div>
<div style="flex:1;overflow-y:auto">
<h3 style="font-size:15px;font-weight:600;letter-spacing:1px;margin-bottom:10px">DIFFICULTY</h3>
<div id="diff-list" class="grid mb-24"></div>
<h3 style="font-size:15px;font-weight:600;letter-spacing:1px;margin-bottom:10px">PACING</h3>
<div id="pace-list" class="grid mb-24"></div>
<h3 style="font-size:15px;font-weight:600;letter-spacing:1px;margin-bottom:10px">AI NARRATOR</h3>
<div class="mono dim mb-8" style="font-size:10px;letter-spacing:2px">LOCAL AI MODEL (runs on your device)</div>
<div id="model-list" class="grid mb-16" style="grid-template-columns:1fr 1fr"></div>
<div id="ai-download-area" style="display:none" class="mb-16">
<div style="padding:12px;background:var(--bg-panel);border:1px solid var(--accent-blue);border-radius:6px">
<div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px" id="ai-dl-status">Ready to download</div>
<div style="background:var(--bg-deep);border-radius:4px;height:8px;overflow:hidden;margin-bottom:8px">
<div id="ai-dl-bar" style="height:100%;background:var(--accent-blue);width:0%;transition:width .3s ease;border-radius:4px"></div>
</div>
<div style="display:flex;gap:8px">
<button class="btn" id="ai-dl-btn" onclick="downloadModel()" style="font-size:12px;padding:6px 14px">‚¨á Download Model</button>
<button class="btn-ghost" style="font-size:11px;padding:4px 10px" onclick="skipAI()">Skip ‚Äî use offline narrator</button>
</div>
<div class="dim" style="font-size:10px;margin-top:8px">Downloads once, plays forever. No internet needed after.</div>
</div></div>
</div>
<div style="display:flex;justify-content:flex-end;padding-top:12px">
<button class="btn" onclick="go('loc')">CONTINUE ‚Üí</button>
</div></div>

<!-- LOCATION SCREEN -->
<div id="loc-screen" class="screen" style="padding:20px">
<div class="fade-in mb-16">
<button class="btn-ghost btn-sm mb-8" onclick="go('diff')">‚Üê BACK</button>
<div class="mono dim mb-4" style="font-size:10px">STEP 3 OF 4</div>
<div class="bar-track mb-12" style="height:3px"><div class="bar-fill" style="width:75%;background:var(--accent-red)"></div></div>
<h2 style="font-size:22px;font-weight:700;letter-spacing:2px;margin-bottom:4px">WHERE DOES IT BEGIN?</h2>
<p class="sec" style="font-size:13px">The apocalypse hits everywhere. Where were you?</p>
</div>
<p class="serif sec mb-16" style="line-height:1.6">Use your real neighborhood for immersion, or generate a fictional town.</p>
<div class="grid mb-16">
<div class="card" id="loc-addr-btn" onclick="locMethod('addr')"><span style="margin-right:8px">üìç</span><strong>MY NEIGHBORHOOD</strong><div class="sec" style="font-size:12px;margin-top:3px">Enter your city or address. Real locations become game zones.</div></div>
<div class="card" id="loc-fic-btn" onclick="locMethod('fic')"><span style="margin-right:8px">üó∫Ô∏è</span><strong>FICTIONAL CITY</strong><div class="sec" style="font-size:12px;margin-top:3px">Generate a procedural town.</div></div>
</div>
<div id="addr-area" style="display:none" class="mb-16">
<div style="display:flex;gap:8px"><input class="input" id="loc-input" placeholder="City, address, or zip code..." style="flex:1"><button class="btn btn-sm" id="loc-search" onclick="locSearch()">üîç</button></div>
<div id="loc-status" class="dim" style="font-size:11px;margin-top:6px"></div>
</div>
<div id="fic-status" style="display:none" class="mb-16">
<div style="padding:10px 12px;background:var(--bg-panel);border:1px solid var(--accent-blue);border-radius:6px">
<div style="font-size:14px;font-weight:700;color:var(--accent-blue)" id="fic-city-name"></div>
<div class="dim" style="font-size:10px;margin-top:4px">Procedurally generated city</div>
<button class="btn-ghost" style="font-size:10px;padding:4px 10px;margin-top:6px" onclick="locMethod('fic')">üé≤ Reroll City</button>
</div>
</div>
<div id="zone-area" style="display:none" class="mb-16">
<h3 style="font-size:14px;font-weight:600;color:var(--accent-amber);margin-bottom:8px">DISCOVERED ZONES (<span id="zone-ct">0</span>)</h3>
<div id="zone-list" style="max-height:200px;overflow-y:auto"></div>
</div>
<div style="display:flex;justify-content:flex-end;padding-top:12px">
<button class="btn" id="loc-next" disabled onclick="go('char')">CONTINUE ‚Üí</button>
</div></div>

<!-- CHARACTER SCREEN -->
<div id="char-screen" class="screen" style="padding:20px">
<div class="fade-in mb-16">
<button class="btn-ghost btn-sm mb-8" onclick="go('loc')">‚Üê BACK</button>
<div class="mono dim mb-4" style="font-size:10px">STEP 4 OF 4</div>
<div class="bar-track mb-12" style="height:3px"><div class="bar-fill" style="width:100%;background:var(--accent-red)"></div></div>
<h2 style="font-size:22px;font-weight:700;letter-spacing:2px;margin-bottom:4px">WHO ARE YOU?</h2>
<p class="sec" style="font-size:13px">Before the world ended, you were someone.</p>
</div>
<div style="flex:1;overflow-y:auto;padding-bottom:72px">
<div class="mb-16"><div class="mono dim mb-4" style="font-size:10px">CHARACTER NAME</div>
<input class="input" id="char-name" placeholder="What's their name?" style="max-width:320px" oninput="checkReady()"></div>
<div class="mb-16"><div class="mono dim mb-8" style="font-size:10px">BACKGROUND</div><div id="bg-list" class="grid"></div></div>
<div class="mb-16"><div class="mono dim mb-8" style="font-size:10px">ATTRIBUTES</div>
<div style="display:flex;gap:8px;margin-bottom:12px"><button class="btn btn-sm" onclick="doRoll()">üé≤ ROLL 4d6</button><button class="btn-ghost btn-sm" onclick="doStd()">STANDARD</button></div>
<div id="attr-grid" class="grid" style="grid-template-columns:1fr 1fr"></div></div>
<div class="mb-16">
<div class="mono dim mb-8" style="font-size:10px">STARTING COMPANIONS <span style="color:var(--text-dim)">(optional, 0-2)</span></div>
<div id="comp-list"></div>
<button class="btn-ghost btn-sm" id="add-comp-btn" onclick="addCompanion()" style="margin-top:8px">+ Add Companion</button>
</div>
</div>
<div style="padding:12px 0;background:var(--bg-deep)">
<button class="btn" id="start-btn" disabled onclick="startGame()" style="width:100%">BEGIN SURVIVAL ‚Üí</button>
</div></div>

<!-- GAME SCREEN -->
<div id="game-screen" class="screen">
<div class="top-bar">
<span style="font-weight:700;font-size:13px;letter-spacing:2px">GZ</span>
<div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
<span class="mono" style="font-size:11px" id="hud-day">Day 1</span>
<span class="mono" style="font-size:11px" id="hud-time">morning</span>
<span class="mono" style="font-size:11px;color:var(--accent-red)" id="hud-threat">‚ö† 0</span>
<span class="mono" style="font-size:10px" id="hud-loc"></span>
<button class="hud-btn" onclick="showSaveMenu()">üíæ</button>
<button class="hud-btn" onclick="toggleDebug()">üêõ</button>
<button class="hud-btn" onclick="confirmReset()">üö™</button>
<button class="tab-btn" id="sb-toggle" onclick="toggleSB()">‚ò∞ INFO</button>
</div></div>
<div id="sidebar-overlay"><div style="display:flex;gap:4px;margin-bottom:12px;flex-wrap:wrap" id="sb-tabs"></div><div id="sb-content"></div></div>
<div id="narrative-scroll"></div>
<div id="action-panel">
<div id="act-label" style="font-size:13px;margin-bottom:6px;color:var(--text-primary)"></div>
<div id="act-btns" class="grid" style="gap:4px;margin-bottom:6px"></div>
<div style="display:flex;gap:8px"><input class="input" id="custom-act" placeholder="Or describe your own action..." style="flex:1;font-size:13px"><button class="btn btn-sm" onclick="doCustom()">ACT</button></div>
</div>
<div id="loading" style="display:none;padding:16px;text-align:center">
<div class="spin-icon" style="margin:0 auto 10px"></div>
<div style="color:var(--text-dim);font-style:italic;font-family:Georgia,serif;font-size:14px" id="loading-text">The story unfolds...</div>
</div>
</div>

<!-- COMBAT OVERLAY -->
<div id="combat-overlay" class="combat-overlay" style="display:none">
<div class="combat-card" style="margin-top:auto;margin-bottom:auto">
<div id="combat-header" style="font-weight:700;font-size:16px;letter-spacing:2px;margin-bottom:12px;color:var(--accent-red)">‚öîÔ∏è COMBAT</div>
<div id="combat-enemies"></div>
<div id="combat-log" style="max-height:150px;overflow-y:auto;margin-bottom:12px"></div>
<div id="combat-actions" class="grid" style="grid-template-columns:1fr 1fr;gap:6px"></div>
</div>
</div>

<!-- CONFIRM DIALOG -->
<div id="confirm-dialog" class="confirm-overlay" style="display:none">
<div class="confirm-box">
<div id="confirm-msg" style="font-size:15px;margin-bottom:16px"></div>
<div id="confirm-body"></div>
<div style="display:flex;gap:8px;justify-content:center;margin-top:16px" id="confirm-btns">
<button class="btn-ghost btn-sm" onclick="hideConfirm()">CANCEL</button>
<button class="btn btn-sm" id="confirm-yes">CONFIRM</button>
</div></div></div>

<!-- DEBUG PANEL -->
<div id="debug-panel">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
<span class="mono" style="color:var(--accent-purple);font-weight:700;letter-spacing:2px">DEBUG</span>
<button class="debug-btn" onclick="toggleDebug()">‚úï CLOSE</button>
</div>
<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px">
<button class="debug-btn" onclick="dbgSetDay()">Set Day</button>
<button class="debug-btn" onclick="dbgSetThreat()">Set Threat</button>
<button class="debug-btn" onclick="dbgSpawnItem()">Spawn Item</button>
<button class="debug-btn" onclick="dbgForceCombat()">Force Combat</button>
<button class="debug-btn" onclick="dbgHeal()">Full Heal</button>
<button class="debug-btn" onclick="dbgAddResources()">+Resources</button>
<button class="debug-btn" onclick="dbgPrintState()">Print State</button>
<button class="debug-btn" onclick="dbgClearSaves()">Clear Saves</button>
</div>
<pre id="debug-log" style="font-size:10px;color:var(--accent-teal);white-space:pre-wrap;max-height:200px;overflow-y:auto"></pre>
</div>

<script>
// ============================================================
// GROUND ZERO v2.0.0
// AI-Powered Zombie Apocalypse Survival RPG
// Single-file HTML5 PWA ‚Ä¢ Offline-capable
// ============================================================

// Origin detection: local file origins (content://, file://, blob:null)
// lack IndexedDB/WASM/module support needed for AI model download.
// AI requires HTTPS origin (GitHub Pages, web server, or PWA install).
var RESTRICTED_ORIGIN=(function(){
  var p=location.protocol;
  if(p==='https:'||p==='http:')return false;
  try{var r=indexedDB.open('_gz_test');r.onsuccess=function(){r.result.close();indexedDB.deleteDatabase('_gz_test')}}catch(e){return true}
  return p==='content:'||p==='file:'||(p==='blob:'&&location.origin==='null');
})();

var SCHEMA_VERSION = 5;

// Character ID generation
var _charIdSeq=0;
function genCharId(){return "c_"+(++_charIdSeq)+"_"+Date.now().toString(36)}

// Character factory ‚Äî creates a fully-formed character object
function makeCharacter(name,bgId,attrs,opts){
  opts=opts||{};
  var bg=BGS.find(function(b){return b.id===bgId});
  var sk={};ASKILLS.forEach(function(s){sk[s]={rank:0,xp:0}});
  if(bg)bg.skills.forEach(function(s){if(sk[s])sk[s].rank=2});
  var em=getMod(attrs.endurance);
  return{
    id:opts.id||genCharId(),
    name:name,
    background:bgId,
    attrs:attrs,
    skills:sk,
    hp:10+em*2,maxHP:10+em*2,
    stamina:6+em,maxStamina:6+em,
    morale:opts.morale||60,
    conditions:[],
    inventory:opts.inventory||[],
    // Roster fields
    status:opts.status||"active", // active|base|mission|dead|missing
    assignment:null,
    zone:opts.zone||"base",
    isLeader:!!opts.isLeader,
    loyalty:opts.loyalty||70,
    relationships:{},
    joinedDay:opts.joinedDay||1,
    portrait:opts.portrait||(bg?bg.icon:"üë§"),
    personalGoal:null,
    lastAction:null,
    causeOfDeath:null
  };
}

// Roll a random set of attributes (for NPC/companion generation)
function rollRandomAttrs(){
  var at={};ATTRS.forEach(function(a){var r=roll4d6();at[a.id]=r.total});return at;
}

// Roster helper accessors
function getRosterById(id){
  if(!S.gs||!S.gs.roster)return null;
  return S.gs.roster.find(function(c){return c.id===id})||null;
}
function getActiveParty(){
  if(!S.gs)return[];
  return S.gs.activePartyIds.map(function(id){return getRosterById(id)}).filter(function(c){return c&&c.status==="active"});
}
function getBaseRoster(){
  if(!S.gs)return[];
  return S.gs.roster.filter(function(c){return c.status==="base"});
}
function getAliveRoster(){
  if(!S.gs)return[];
  return S.gs.roster.filter(function(c){return c.status!=="dead"&&c.status!=="missing"});
}
function getLeader(){
  if(!S.gs)return null;
  return S.gs.roster.find(function(c){return c.isLeader})||S.gs.roster[0]||null;
}
function getCurrentActor(){
  if(!S.gs||!S.gs.turnOrder||!S.gs.turnOrder.length)return getLeader();
  return getRosterById(S.gs.turnOrder[S.gs.currentActorIndex])||getLeader();
}

var ZDB = {
origins:{"Virus":[{"subType":"Engineered","source":"Resident Evil","desc":"T-Virus created by Umbrella Corporation as bioweapon","cure":"Possible (antivirus)"},{"subType":"Engineered","source":"28 Days Later","desc":"Rage virus engineered from modified ebola, escaped from Cambridge lab","cure":"Unknown/None shown"},{"subType":"Engineered","source":"I Am Legend","desc":"Krippin virus - engineered cancer cure mutated","cure":"Possible (immunity exists)"},{"subType":"Natural Mutation","source":"World War Z (book)","desc":"Solanum virus - origin unknown, possibly ancient","cure":"No cure"},{"subType":"Natural Mutation","source":"The Walking Dead","desc":"Unknown virus already present in all humans, activates on death","cure":"No cure"},{"subType":"Weaponized","source":"Resident Evil (film)","desc":"T-Virus weaponized and released in the Hive facility","cure":"Anti-virus exists but limited"}],"Fungus":[{"subType":"Cordyceps Mutation","source":"The Last of Us","desc":"Mutated Cordyceps fungus adapted to human hosts through climate change","cure":"No cure (immune individuals exist)"},{"subType":"Parasitic Fungal","source":"Girl With All the Gifts","desc":"Ophiocordyceps variant that takes over brain function","cure":"No cure - next stage of evolution"}],"Parasite":[{"subType":"Engineered Parasite","source":"Resident Evil 4","desc":"Las Plagas - ancient parasite weaponized by Los Illuminados cult","cure":"Surgical removal (early stage)"},{"subType":"Alien Parasite","source":"Slither","desc":"Alien organism infects and merges with hosts","cure":"Destroy the source organism"}],"Radiation":[{"subType":"Space Radiation","source":"Night of the Living Dead","desc":"Radiation from Venus probe returning to Earth (implied)","cure":"Unknown"},{"subType":"Nuclear","source":"Various","desc":"Nuclear radiation reanimates dead tissue","cure":"Unknown"}],"Supernatural":[{"subType":"Voodoo/Curse","source":"White Zombie / Serpent and the Rainbow","desc":"Haitian voodoo creates zombies through ritual and toxins","cure":"Break the curse/kill the bokor"},{"subType":"Demonic","source":"Evil Dead","desc":"Necronomicon incantation releases demonic force","cure":"Destroy the Necronomicon"},{"subType":"Divine Punishment","source":"Various religious horror","desc":"Apocalyptic event - the dead rising as divine judgment","cure":"None - eschatological"}],"Chemical":[{"subType":"Military Chemical","source":"Return of the Living Dead","desc":"Trioxin gas reanimates dead tissue, created by military","cure":"No cure (even burning spreads it via rain)"},{"subType":"Industrial Accident","source":"Various","desc":"Chemical spill or industrial accident causes reanimation","cure":"Varies"}],"Nano-tech":[{"subType":"Nanobots","source":"Various sci-fi","desc":"Nanomachines that reanimate and control dead tissue","cure":"EMP or killswitch"},{"subType":"Grey Goo Variant","source":"Hypothetical","desc":"Self-replicating nanomachines that repurpose organic matter","cure":"Counter-nanobots or EMP"}],"Alien":[{"subType":"Alien Signal","source":"Dead Space","desc":"Marker signal converts dead tissue into Necromorphs","cure":"Destroy the Marker"},{"subType":"Alien Organism","source":"The Thing (adjacent)","desc":"Alien organism that assimilates and mimics hosts","cure":"Incineration"}],"Prion":[{"subType":"Mutated Prion","source":"Hypothetical","desc":"Modified prion disease causing aggressive behavior and brain death","cure":"No cure (prions are nearly indestructible)"}],"Unknown":[{"subType":"Unexplained","source":"Night of the Living Dead","desc":"Never definitively explained","cure":"Unknown"},{"subType":"Unexplained","source":"Zombieland","desc":"Modified strain of mad cow disease (vaguely mentioned)","cure":"None shown"}]},

vectors:[{"type":"Bite","source":"The Walking Dead","desc":"Zombie bite causes fever then death then reanimation","rate":"100% lethal, hours to days","prevention":"Amputation of bitten limb"},{"type":"Bite","source":"28 Days Later","desc":"Rage virus through bite, extremely fast onset","rate":"Near instant (10-20 seconds)","prevention":"Avoid all contact, ranged weapons"},{"type":"Scratch","source":"Dying Light","desc":"Scratches can transmit if deep enough","rate":"Lower than bite","prevention":"Armor, thick clothing"},{"type":"Airborne","source":"Return of the Living Dead","desc":"Trioxin becomes airborne when zombies are burned","rate":"Area-wide, unavoidable","prevention":"Gas masks, avoid burning"},{"type":"Bodily Fluids","source":"28 Days Later","desc":"Any infected blood in eyes/mouth/wound transmits rage virus","rate":"Near instant on contact","prevention":"Face shields, full body cover"},{"type":"Spores","source":"The Last of Us","desc":"Cordyceps releases spores in enclosed spaces from dead infected","rate":"Inhalation = infection","prevention":"Gas masks in spore zones"},{"type":"Waterborne","source":"Hypothetical","desc":"Pathogen survives in water supply","rate":"Slow spread, mass infection","prevention":"Water purification"},{"type":"Death (All Reanimate)","source":"The Walking Dead","desc":"Everyone already carries it - any death triggers reanimation","rate":"Universal, unavoidable","prevention":"Destroy brain on death"},{"type":"Insect Carrier","source":"Various","desc":"Mosquitoes or flies carry pathogen between hosts","rate":"Seasonal, geographic","prevention":"Bug repellent, nets"},{"type":"Proximity","source":"Dead Space","desc":"Marker signal converts nearby dead tissue","rate":"Area effect, unavoidable near Marker","prevention":"Distance from source"},{"type":"Eye Contact","source":"Hypothetical","desc":"Psychic connection through direct gaze","rate":"Individual, unavoidable in encounter","prevention":"Blindfolds, indirect observation"},{"type":"Ritual/Curse","source":"Evil Dead","desc":"Cursed objects or incantations","rate":"Targeted, not pandemic","prevention":"Destroy cursed items"}],

speedCategories:[{"id":"instant","label":"Instant (0-30 sec)","sources":"28 Days Later, World War Z (film)","details":"Transformation in seconds. No rescue window."},{"id":"very_fast","label":"Very Fast (1-5 min)","sources":"Train to Busan","details":"Minutes to transform. Frantic amputation decisions."},{"id":"fast","label":"Fast (5-30 min)","sources":"Dying Light, Left 4 Dead","details":"Short window for treatment or quarantine."},{"id":"moderate","label":"Moderate (1-6 hours)","sources":"World War Z (book)","details":"Time for quarantine protocols and preparation."},{"id":"slow","label":"Slow (6-24 hours)","sources":"The Walking Dead, Resident Evil","details":"Fever, delirium, slow decline. Emotional goodbyes."},{"id":"very_slow","label":"Very Slow (Days-Weeks)","sources":"The Last of Us","details":"Staged progression. Runner to Clicker over weeks."},{"id":"variable","label":"Variable/Staged","sources":"Dying Light, I Am Legend","details":"Suppressible with medicine, worsens over time."}],

zombieTypes:[{"name":"Shambler/Walker","archetype":"Basic","source":"TWD / Night of the Living Dead","abilities":"Slow, relentless, strength in numbers","weaknesses":"Slow, fragile individually","threat":3,"role":"Fodder / Horde Unit"},{"name":"Runner/Sprinter","archetype":"Fast","source":"28 Days Later / Train to Busan","abilities":"Full sprint, tireless, aggressive","weaknesses":"Same durability as standard","threat":7,"role":"Pursuit / Ambush"},{"name":"Clicker","archetype":"Sensory","source":"The Last of Us","abilities":"Echolocation, armored head, one-hit kill","weaknesses":"Blind, fungal plates breakable","threat":8,"role":"Stealth Challenge"},{"name":"Bloater","archetype":"Tank","source":"The Last of Us / Left 4 Dead","abilities":"Massive, throws acid/bile, extremely tough","weaknesses":"Very slow, large target","threat":9,"role":"Boss / Area Denial"},{"name":"Screamer","archetype":"Support","source":"Dying Light / Left 4 Dead","abilities":"Alerts all nearby zombies, summons hordes","weaknesses":"Fragile, no direct combat","threat":6,"role":"Priority Target"},{"name":"Spitter","archetype":"Ranged","source":"Left 4 Dead 2 / Dying Light","abilities":"Ranged acid projectile attack","weaknesses":"Weak in melee, slow","threat":5,"role":"Ranged Threat"},{"name":"Hunter/Pouncer","archetype":"Ambush","source":"Left 4 Dead / Dying Light","abilities":"Leaps great distances, pins targets","weaknesses":"Vulnerable mid-air","threat":7,"role":"Flanker / Ambush"},{"name":"Volatile/Night","archetype":"Apex","source":"Dying Light","abilities":"Extreme speed, UV sensitive, pack hunter","weaknesses":"Destroyed by UV/sunlight","threat":10,"role":"Night Terror"},{"name":"Licker","archetype":"Mutant","source":"Resident Evil","abilities":"Wall/ceiling crawling, blade tongue, fast","weaknesses":"Blind, sound-based detection","threat":8,"role":"Stealth Predator"},{"name":"Tyrant/Nemesis","archetype":"Boss","source":"Resident Evil","abilities":"Superhuman strength, intelligent, regenerates","weaknesses":"Requires heavy weapons, weak to fire","threat":10,"role":"Pursuit Boss"},{"name":"Witch","archetype":"Dormant","source":"Left 4 Dead","abilities":"One-hit kill, triggered by proximity/light","weaknesses":"Only attacks when disturbed","threat":8,"role":"Environmental Hazard"},{"name":"Hive Mind Node","archetype":"Controller","source":"Dead Space","abilities":"Coordinates all nearby undead, psychic","weaknesses":"Kill node = weaken group","threat":9,"role":"Strategic Target"},{"name":"Smart Zombie","archetype":"Intelligent","source":"Land of the Dead / Army of the Dead","abilities":"Uses tools, coordinates others, remembers","weaknesses":"Can be predicted, negotiated with","threat":8,"role":"Leader / Tactician"},{"name":"Fungal Sentinel","archetype":"Stationary","source":"The Last of Us","abilities":"Fused to walls, releases spores on disturbance","weaknesses":"Immobile, destroyable from range","threat":2,"role":"Environmental Trap"},{"name":"Crawler","archetype":"Damaged","source":"Various","abilities":"Low to ground, hard to spot, trip hazard","weaknesses":"Slow, easily killed","threat":2,"role":"Hidden Danger"},{"name":"Hybrid Mutant","archetype":"Evolved","source":"Resident Evil / TLOU","abilities":"Combined abilities, boss-tier","weaknesses":"Specific weak points","threat":9,"role":"Boss / Set Piece"},{"name":"Swarm/Insect","archetype":"Swarm","source":"Various","abilities":"Thousands of tiny infected, overwhelming","weaknesses":"Fire, contained spaces","threat":7,"role":"Area Hazard"},{"name":"Armored","archetype":"Defensive","source":"Dying Light / Dead Rising","abilities":"Protected by gear/mutation, hard to damage","weaknesses":"Slow, vulnerable spots","threat":6,"role":"Obstacle / Mini-boss"}],

intelligenceLevels:["Mindless (no awareness, pure stimulus)","Instinctive (swarm behavior, basic pursuit)","Cunning (sets ambushes, remembers paths)","Tool-Using (opens doors, uses objects)","Strategic (coordinates groups, plans)","Sentient (speaks, negotiates, has goals)","Hive Mind (collective intelligence)"],

killMethods:["Headshot","Decapitation","Brain destruction (melee)","Total body destruction","Fire/Incineration","UV/Sunlight","Starvation (wait them out)","Freezing","Acid/Chemical dissolution","Explosive","Electrical","Remove infection source","Drowning (some variants)","Wood chipper / Industrial","Destroy the hive source"],

senseProfiles:[{"type":"Sight","levels":["Normal human","Enhanced/night vision","Blind","Motion-detection only"]},{"type":"Sound","levels":["Attracted to noise","Echolocation (Clickers)","Deaf","Mimics sounds to lure"]},{"type":"Smell","levels":["Detects living flesh","Enhanced (bloodhound)","No smell sense","Fooled by camouflage"]},{"type":"Hive/Psychic","levels":["None","Proximity awareness","Full hive mind","Marker/signal based"]}],

decayRates:["No decay (living infected)","No decay (preserved undead)","Very slow (years to decades)","Standard (months)","Fast (weeks)","Climate variable (heat accelerates)","Fungal growth (transforms rather than decays)"],

hordeBehaviors:["Solitary wanderer (1-3)","Small pack (4-12)","Herd/Migration (50-500+)","Siege (surrounds structure, waits)","Feeding frenzy (attracted to kill)","Dormant cluster (sleeping mass)","Coordinated assault (intelligent)","Territorial patrol","Nomadic horde (follows patterns)","Swarm intelligence (acts as one)"],

cureStatuses:["No cure possible","No cure but self-limiting (burns out)","Partial treatment (slows progression)","Antivirus exists but rare","Early-stage reversible","Surgical removal possible","Immunity exists in some","Vaccine preventable","Full cure discoverable","Magical/ritual reversal"],

collapseTimelines:["Instant (hours)","Rapid (days to weeks)","Fast (weeks to months)","Gradual (months to years)","Slow (years)","Regional/Contained","Already collapsed (story begins after)","Ongoing (society adapting)"],

nonHumanHosts:["Dogs","Crows/Birds","Horses/Livestock","Bears/Large predators","Insects (swarm carriers)","Fish/Aquatic (water threats)","Rats (urban plague)","Deer/Wildlife","Apes/Primates","Plants (fungal overgrowth)","None (humans only)"],

environmentalFactors:["Extreme cold freezes zombies","Extreme heat accelerates decay","Humidity promotes fungal growth","Rain spreads waterborne infection","Darkness empowers night variants","UV/Sunlight destroys some types","Underwater zombies possible","Urban density = more zombies","Rural = fewer but more isolated","Seasonal cycles affect threat"],

evolutionTypes:["Static (never change)","Decay progression (weaker over time)","Staged infection (stronger over time)","Adaptive mutation (new abilities)","Reactive evolution (counter human tactics)","Seasonal cycling (dormant/active)","Host merger (combine into larger forms)","Speciation (split into sub-types)"],

driveTypes:["Hunger - brains specifically","Hunger - all flesh","Hunger - required to survive","Pure rage/aggression","Spread infection (reproduction)","Hive directive","Instinct/stimulus response","None/aimless wandering","Pack/social grouping","Territorial"],

soundTypes:["Silent","Moaning (passive alert)","Screaming (active alarm)","Clicking (echolocation)","Hive telepathy (silent coordination)","Mimicry (imitates human speech)","Speech fragments (partial sentences)","Wailing/crying (lure)","Chittering (swarm coordination)","Roaring (territorial/aggression)"],

mobilityClasses:["Immobile (stationary hazard)","Crawling only","Shamble (very slow walk)","Slow walk","Normal walking pace","Jogging speed","Full sprint","Superhuman speed","Climbing/Wall-crawling","Burrowing/Underground","Leaping/Pouncing","Swimming"]
};
var PRESETS = [
// Original presets
{id:"walking_dead",name:"The Walking Dead",tag:"The real monsters are human",desc:"Slow walkers. Extreme scarcity. Moral drama. Everyone is already infected.",color:"#6a6a5a",category:"tv",
 tone:"Moral drama. Quiet dread. Long silences punctuated by violence.",rule:"All dead reanimate. No cure. Slow shamblers. Humans are the real threat.",scarcity:.6,
 config:{origin:"Virus",vector:["Bite","Death (All Reanimate)"],speed:"slow",types:["Shambler/Walker","Crawler"],intelligence:0,senses:"sound+smell",decay:"Very slow",horde:"Herd/Migration",cure:"No cure",collapse:"Fast",mobility:"Shamble",drives:"Hunger - all flesh",sounds:"Moaning",evolution:"Decay progression"}},

{id:"world_war_z",name:"World War Z",tag:"The swarm consumes everything",desc:"Fast hordes. Military collapse. Global chaos. Amputation prevents infection.",color:"#4a5a3a",category:"film",
 tone:"Global collapse. Military remnants. Scale and desperation.",rule:"Horde events 2x frequency. Amputation prevents infection. Massive swarms.",scarcity:.75,
 config:{origin:"Virus",vector:["Bite"],speed:"moderate",types:["Shambler/Walker","Runner/Sprinter"],intelligence:1,senses:"sound+sight",decay:"No decay (preserved)",horde:"Swarm intelligence",cure:"No cure",collapse:"Rapid",mobility:"Full sprint",drives:"Hunger - all flesh",sounds:"Moaning",evolution:"Static"}},

{id:"twenty_eight_days",name:"28 Days Later",tag:"Silence is survival",desc:"Rage sprinters. Constant terror. Blood = instant infection.",color:"#8a3a2a",category:"film",
 tone:"Constant terror. Sprint or die. Empty cities that echo.",rule:"Blood contact infects in seconds. Infected starve after 28 days. They are NOT dead.",scarcity:.85,
 config:{origin:"Virus",vector:["Bite","Bodily Fluids"],speed:"instant",types:["Runner/Sprinter"],intelligence:0,senses:"sight+sound",decay:"No decay (living)",horde:"Feeding frenzy",cure:"Self-limiting",collapse:"Instant",mobility:"Full sprint",drives:"Pure rage",sounds:"Screaming",evolution:"Static"}},

{id:"shaun_of_the_dead",name:"Shaun of the Dead",tag:"Business as (un)usual",desc:"Slow, clumsy zombies. Dark comedy. Relationships matter most.",color:"#7a6a3a",category:"film",
 tone:"Dark comedy played straight. Personal relationships matter most. British deadpan.",rule:"Morale penalties halved. Social DCs -2. Zombies are slow and dumb.",scarcity:.95,
 config:{origin:"Unknown",vector:["Bite"],speed:"slow",types:["Shambler/Walker"],intelligence:0,senses:"sound+sight",decay:"Standard",horde:"Small pack",cure:"No cure",collapse:"Gradual",mobility:"Shamble",drives:"Hunger - all flesh",sounds:"Moaning",evolution:"Static"}},

{id:"resident_evil",name:"Resident Evil",tag:"Umbrella did this",desc:"Bioengineered virus. Mutations. Corporate conspiracy. Lab horrors.",color:"#3a4a6a",category:"game",
 tone:"Corporate horror. Escalating mutations. Conspiracy layers.",rule:"Special Infected 2x. Labs contain antivirals. Boss mutations escalate.",scarcity:.8,
 config:{origin:"Virus",vector:["Bite","Scratch"],speed:"slow",types:["Shambler/Walker","Licker","Tyrant/Nemesis","Hybrid Mutant"],intelligence:1,senses:"sound",decay:"Very slow",horde:"Small pack",cure:"Antivirus exists",collapse:"Contained",mobility:"Normal walk",drives:"Hunger - all flesh",sounds:"Moaning",evolution:"Adaptive mutation"}},

{id:"state_of_decay",name:"State of Decay",tag:"Every person matters",desc:"Community focus. Mixed zombies. Base building. Resource management.",color:"#5a7a4a",category:"game",
 tone:"Strategic survival. Community management. Tough calls about who lives.",rule:"Base building -25% cost. Extra morale granularity. Community members can die.",scarcity:.8,
 config:{origin:"Unknown",vector:["Bite"],speed:"moderate",types:["Shambler/Walker","Screamer","Bloater"],intelligence:0,senses:"sound+smell",decay:"Standard",horde:"Herd/Migration",cure:"No cure",collapse:"Fast",mobility:"Slow walk",drives:"Hunger - all flesh",sounds:"Screaming",evolution:"Static"}},

// NEW PRESETS
{id:"last_of_us",name:"The Last of Us",tag:"When you're lost in the darkness, look for the light",desc:"Cordyceps fungus. Staged infection. Clickers. Spore zones. Brutal human factions.",color:"#5a7a5a",category:"game",
 tone:"Melancholic beauty. Human connections in a ruined world. Violence as last resort.",rule:"Infection via bite or spores. Staged zombies: Runner‚ÜíStalker‚ÜíClicker‚ÜíBloater. Gas masks required in spore zones.",scarcity:.65,
 config:{origin:"Fungus",vector:["Bite","Spores"],speed:"very_slow",types:["Runner/Sprinter","Clicker","Bloater","Fungal Sentinel","Hybrid Mutant"],intelligence:1,senses:"echolocation+smell",decay:"Fungal growth",horde:"Dormant cluster",cure:"No cure (immunity rare)",collapse:"Fast",mobility:"Normal walk to sprint",drives:"Spread infection",sounds:"Clicking",evolution:"Staged infection"}},

{id:"train_to_busan",name:"Train to Busan",tag:"The last train out of hell",desc:"Ultra-fast infection. Enclosed spaces. Civilian panic. No military rescue coming.",color:"#7a4a3a",category:"film",
 tone:"Claustrophobic terror. Selflessness vs selfishness. Every second counts.",rule:"Bite transforms in under a minute. Zombies can't see in dark. Enclosed spaces amplify danger.",scarcity:.7,
 config:{origin:"Virus",vector:["Bite"],speed:"very_fast",types:["Runner/Sprinter"],intelligence:0,senses:"sight+sound",decay:"No decay (living)",horde:"Feeding frenzy",cure:"No cure",collapse:"Rapid",mobility:"Full sprint",drives:"Hunger - all flesh",sounds:"Screaming",evolution:"Static"}},

{id:"dying_light",name:"Dying Light",tag:"Good night. Good luck.",desc:"Parkour survival. Day scavenging, night terror. Volatiles hunt at dark.",color:"#6a5a2a",category:"game",
 tone:"Adrenaline-fueled. Day/night cycle creates constant tension. Verticality matters.",rule:"Night doubles all zombie stats. Volatiles appear at dusk. UV flashlights repel. Parkour escape mechanics.",scarcity:.75,
 config:{origin:"Virus",vector:["Bite","Scratch"],speed:"fast",types:["Shambler/Walker","Runner/Sprinter","Volatile/Night","Screamer","Spitter"],intelligence:2,senses:"sight+sound+UV-sensitive",decay:"No decay",horde:"Territorial patrol",cure:"Partial treatment (Antizin)",collapse:"Contained",mobility:"Sprint to superhuman",drives:"Hunger + territorial",sounds:"Screaming",evolution:"Adaptive mutation"}},

{id:"left_4_dead",name:"Left 4 Dead",tag:"No mercy",desc:"Special infected with unique abilities. Co-op survival. Safe rooms. Director AI.",color:"#4a6a3a",category:"game",
 tone:"Intense action horror. Dark humor. Teamwork or death.",rule:"Special infected appear regularly. Hordes triggered by car alarms, witch cries. Safe rooms restore health.",scarcity:.85,
 config:{origin:"Virus",vector:["Bite","Bodily Fluids"],speed:"fast",types:["Runner/Sprinter","Hunter/Pouncer","Smoker","Bloater","Witch","Screamer","Spitter"],intelligence:1,senses:"sight+sound",decay:"No decay",horde:"Feeding frenzy",cure:"No cure",collapse:"Rapid",mobility:"Sprint to leaping",drives:"Hunger + rage",sounds:"Screaming",evolution:"Speciation"}},

{id:"i_am_legend",name:"I Am Legend",tag:"The last man on Earth is not alone",desc:"Darkseekers. UV destroys them. Night hunters. Potential intelligence. Absolute isolation.",color:"#3a3a6a",category:"film",
 tone:"Profound isolation. Scientific hope. Night as absolute terror.",rule:"Enemies only at night. UV/sunlight kills. Darkseekers are intelligent and fast. Traps work both ways.",scarcity:.9,
 config:{origin:"Virus",vector:["Bite","Bodily Fluids"],speed:"slow",types:["Volatile/Night","Smart Zombie"],intelligence:4,senses:"enhanced night vision+smell",decay:"No decay (living)",horde:"Coordinated assault",cure:"Early-stage reversible",collapse:"Already collapsed",mobility:"Full sprint",drives:"Hunger + pack social",sounds:"Screaming",evolution:"Adaptive mutation"}},

{id:"days_gone",name:"Days Gone",tag:"Ride to survive",desc:"Massive freaker hordes with patterns. Open world motorcycle survival. Nest clearing.",color:"#5a5a3a",category:"game",
 tone:"Open road desolation. Biker survival. Clear nests, track hordes, ride fast.",rule:"Hordes follow day/night patterns (nest by day, water by night). Motorcycle is lifeline. Nests must be burned.",scarcity:.7,
 config:{origin:"Virus",vector:["Bite"],speed:"moderate",types:["Runner/Sprinter","Screamer","Bloater"],intelligence:1,senses:"sight+sound+smell",decay:"No decay",horde:"Nomadic horde",cure:"Partial treatment",collapse:"Fast",mobility:"Jogging to sprint",drives:"Hunger + instinct",sounds:"Screaming",evolution:"Staged infection"}},

{id:"dead_space",name:"Dead Space",tag:"CUT OFF THEIR LIMBS",desc:"Necromorphs. Alien marker signal. Dismemberment required. Psychological horror.",color:"#4a4a5a",category:"game",
 tone:"Cosmic horror. Claustrophobic. Psychological unraveling. Trust nothing.",rule:"Headshots DON'T work. Must dismember limbs. Marker signal causes hallucinations. Dead bodies can reanimate.",scarcity:.8,
 config:{origin:"Alien",vector:["Proximity","Death (All Reanimate)"],speed:"fast",types:["Hunter/Pouncer","Swarm/Insect","Hive Mind Node","Hybrid Mutant"],intelligence:6,senses:"hive signal",decay:"No decay (alien tissue)",horde:"Coordinated assault",cure:"Destroy the Marker",collapse:"Contained",mobility:"Climbing + leaping",drives:"Hive directive",sounds:"Chittering",evolution:"Host merger"}},

{id:"return_of_living_dead",name:"Return of the Living Dead",tag:"SEND MORE COPS",desc:"Talking zombies. Brains specifically. Indestructible. Trioxin gas. Punk horror comedy.",color:"#6a4a6a",category:"film",
 tone:"Punk rock horror comedy. Zombies that talk and plan. Darkly hilarious.",rule:"Headshots DON'T work. Must destroy entire body. Burning creates toxic rain. Zombies can use radios.",scarcity:.85,
 config:{origin:"Chemical",vector:["Airborne","Bite"],speed:"fast",types:["Smart Zombie","Runner/Sprinter"],intelligence:5,senses:"smell (brains)",decay:"No decay",horde:"Coordinated assault",cure:"No cure (indestructible)",collapse:"Contained",mobility:"Jogging",drives:"Hunger - brains",sounds:"Mimicry",evolution:"Static"}},

{id:"zombieland",name:"Zombieland",tag:"Rule #1: Cardio",desc:"Comedy survival. Rules to live by. Road trip. Enjoy the little things.",color:"#8a7a3a",category:"film",
 tone:"Comedy horror. Rules-based survival wisdom. Found family on the road.",rule:"Double Tap always. Cardio matters. Check the back seat. Enjoy the little things.",scarcity:.9,
 config:{origin:"Prion",vector:["Bite"],speed:"moderate",types:["Runner/Sprinter","Shambler/Walker"],intelligence:0,senses:"sight+sound",decay:"Standard",horde:"Feeding frenzy",cure:"No cure",collapse:"Fast",mobility:"Jogging to sprint",drives:"Hunger - all flesh",sounds:"Screaming",evolution:"Static"}},

{id:"army_of_dead",name:"Army of the Dead",tag:"There are some smart ones",desc:"Intelligent alpha zombies. Zombie society. Heist in quarantine zone.",color:"#7a5a3a",category:"film",
 tone:"Action heist meets zombie apocalypse. Zombie hierarchy with alphas.",rule:"Alpha zombies are intelligent, fast, organized. They have a king/queen. They grieve. They negotiate territory.",scarcity:.75,
 config:{origin:"Unknown",vector:["Bite"],speed:"fast",types:["Shambler/Walker","Runner/Sprinter","Smart Zombie","Armored"],intelligence:5,senses:"sight+sound+enhanced",decay:"No decay",horde:"Coordinated assault",cure:"No cure",collapse:"Contained",mobility:"Sprint to superhuman",drives:"Pack/social + territorial",sounds:"Roaring",evolution:"Adaptive mutation"}},

{id:"world_war_z_book",name:"World War Z (Book)",tag:"Total war against the dead",desc:"Realistic global pandemic response. Military strategy. Oral history format. Slow, relentless zombies.",color:"#3a5a4a",category:"book",
 tone:"Documentary realism. Global scale. Military precision. Political failure.",rule:"Slow but relentless. Freeze in winter, thaw in spring. Underwater zombies exist. Solanum is 100% fatal, no cure ever.",scarcity:.65,
 config:{origin:"Virus",vector:["Bite"],speed:"moderate",types:["Shambler/Walker"],intelligence:1,senses:"sound+sight",decay:"No decay (preserved)",horde:"Herd/Migration",cure:"No cure possible",collapse:"Gradual",mobility:"Slow walk",drives:"Hunger - all flesh",sounds:"Moaning",evolution:"Static"}},

{id:"the_road",name:"The Road",tag:"Carry the fire",desc:"Post-apocalyptic bleakness beyond zombies. Ash-covered wasteland. Cannibal gangs. Father and son.",color:"#4a4a4a",category:"book",
 tone:"Absolute bleakness. Unconditional love as the only light. Ash and silence.",rule:"Resources nearly zero. Humans are the primary threat. Cold, hunger, despair. Morale is everything.",scarcity:.3,
 config:{origin:"Unknown",vector:["Bite"],speed:"slow",types:["Shambler/Walker"],intelligence:0,senses:"sound",decay:"Very slow",horde:"Solitary wanderer",cure:"No cure",collapse:"Already collapsed",mobility:"Shamble",drives:"None/aimless",sounds:"Silent",evolution:"Decay progression"}},

{id:"evil_dead",name:"Evil Dead",tag:"Join us",desc:"Demonic possession. Necronomicon. Body horror. Cabin in the woods. Chainsaw hand.",color:"#6a3a3a",category:"film",
 tone:"Demonic horror comedy. Extreme body horror. Campy terror. Groovy.",rule:"Supernatural origin - can't be killed normally. Must destroy Necronomicon or use rituals. Dismemberment required. Possessed retain memories.",scarcity:.8,
 config:{origin:"Supernatural",vector:["Ritual/Curse","Bite"],speed:"instant",types:["Smart Zombie","Hybrid Mutant"],intelligence:5,senses:"supernatural awareness",decay:"No decay",horde:"Small pack",cure:"Destroy Necronomicon",collapse:"Contained",mobility:"Superhuman",drives:"Spread infection + rage",sounds:"Mimicry",evolution:"Adaptive mutation"}}
];

// Core game data
var DIFFS=[{id:"casual",name:"Casual",desc:"Plentiful resources. Forgiving combat.",dcMod:-2},{id:"survival",name:"Survival",desc:"Scarce resources. Real consequences.",dcMod:0,rec:1},{id:"nightmare",name:"Nightmare",desc:"Extreme scarcity. Brutal combat.",dcMod:2}];
var PACES=[{id:"fast",name:"Fast Days",desc:"1 mission = 1 day."},{id:"slow",name:"Slow Days",desc:"2-4 missions = 1 day. Gritty.",rec:1}];
var BGS=[
{id:"military",name:"Military / Police",skills:["firearms","survival"],flavor:"Trained to fight. Now there are no orders.",icon:"üõ°Ô∏è"},
{id:"medical",name:"Medical Professional",skills:["first_aid","diagnosis"],flavor:"Every group needs one. That's your curse.",icon:"‚ù§Ô∏è"},
{id:"mechanic",name:"Mechanic / Trades",skills:["craft_mech","repair"],flavor:"If it's broken, you can fix it.",icon:"üîß"},
{id:"academic",name:"Teacher / Academic",skills:["leadership","search"],flavor:"You learn fast. Only edge that matters.",icon:"üß†"},
{id:"outdoors",name:"Outdoors / Rural",skills:["foraging","tracking"],flavor:"The woods were home. Now everything is.",icon:"üèïÔ∏è"},
{id:"criminal",name:"Criminal / Street",skills:["lockpicking","stealth"],flavor:"You survived before. Change of predators.",icon:"üëÅÔ∏è"},
{id:"engineer",name:"Engineer / IT",skills:["craft_elec","craft_struct"],flavor:"You see structures in rubble.",icon:"‚öôÔ∏è"},
{id:"athlete",name:"Athlete / Fitness",skills:["melee","evasion"],flavor:"Your body is your best tool.",icon:"‚ö°"},
{id:"caretaker",name:"Parent / Caretaker",skills:["first_aid","sense_motive"],flavor:"You'll do anything for your people.",icon:"üë•"}
];
var ATTRS=[{id:"fitness",abbr:"FIT",name:"Fitness",desc:"Melee, carry, climb"},{id:"agility",abbr:"AGI",name:"Agility",desc:"Ranged, dodge, stealth"},{id:"endurance",abbr:"END",name:"Endurance",desc:"HP, stamina, disease"},{id:"wits",abbr:"WIT",name:"Wits",desc:"Craft, repair, medicine"},{id:"awareness",abbr:"AWR",name:"Awareness",desc:"Perception, tracking"},{id:"presence",abbr:"PRS",name:"Presence",desc:"Leadership, persuasion"}];
var SMAP={melee:"fitness",firearms:"agility",evasion:"agility",foraging:"awareness",navigation:"awareness",tracking:"awareness",craft_struct:"wits",craft_mech:"wits",craft_elec:"wits",repair:"wits",stealth:"agility",lockpicking:"agility",search:"wits",spot:"awareness",listen:"awareness",persuasion:"presence",intimidation:"presence",deception:"presence",sense_motive:"awareness",barter:"presence",leadership:"presence",first_aid:"wits",surgery:"wits",diagnosis:"wits",drive:"agility",survival:"endurance"};
var ASKILLS=Object.keys(SMAP);
// Zone generation system ‚Äî procedural names, balanced categories
var ZONE_TEMPLATES=[
{cat:"supermarket",label:"Grocery",danger:2,tags:["food"],names:["FreshMart","SaveMore","Green Basket","Daily Harvest","Corner Market","Sunrise Foods","Good Value","QuickStop Grocery","Valley Market","Town Pantry","Lakeside Grocery","Hilltop Market"]},
{cat:"pharmacy",label:"Pharmacy",danger:2,tags:["medical"],names:["MedPlus","QuickCare Pharmacy","Elm Drug","Wellpoint","RiteAid Plus","Clearview Pharmacy","Central Drug","Pine Pharmacy","Oakmont Drugs","Sunset Pharmacy"]},
{cat:"hospital",label:"Hospital",danger:4,tags:["medical"],names:["County General","Mercy Hospital","St. Bridget Medical","Regional Medical Center","Hope Memorial","Riverside General","Valley Health","Crestwood Hospital","Metro ER","Northside Medical"]},
{cat:"hardware",label:"Hardware",danger:2,tags:["industrial"],names:["Henderson Hardware","TrueValue","BuildRight","Ace Home Center","Doug\'s Hardware","Fix-It Depot","Iron & Nail","Hammer & Tong","Pioneer Supply","Bolt Hardware"]},
{cat:"fuel",label:"Gas Station",danger:3,tags:["fuel"],names:["QuikFuel","Sunoco Express","Roadside Fill-Up","Shell Stop","AmeriGas","Last Chance Fuel","Crossroads Gas","Route 9 Fuel","Pit Stop","FastLane Gas"]},
{cat:"police",label:"Police Station",danger:4,tags:["military"],names:["Precinct 14","Central Police","Sheriff\'s Office","District 7 PD","Metro Police HQ","Southside Station","Downtown Precinct","County Sheriff","Municipal Police","Patrol Station 3"]},
{cat:"fire_station",label:"Fire Station",danger:2,tags:["industrial"],names:["Engine Co. #7","Ladder 12","Station 5","Firehouse 9","Hook & Ladder 3","Rescue Squad 8","Engine 14","Pumper Station 2","Fire Station 11","Central Fire"]},
{cat:"school",label:"School",danger:2,tags:["residential"],names:["Lincoln Elementary","Westfield High","Roosevelt Middle","Fairview Academy","Oak Ridge School","Jefferson Primary","Maple Grove School","Washington High","Lakewood Elementary","Kennedy Middle"]},
{cat:"church",label:"Church",danger:1,tags:["residential"],names:["First Methodist","St. Mark\'s","Grace Chapel","Trinity Church","Our Lady of Hope","Community Bible","Redeemer Lutheran","Faith Tabernacle","Sacred Heart","Covenant Church"]},
{cat:"park",label:"Park",danger:1,tags:["water"],names:["Memorial Park","Riverside Green","Veterans Park","Oakwood Commons","Sunset Gardens","Liberty Park","Willow Creek Park","Eagle Point","Cedar Grove","Millpond Park"]},
{cat:"library",label:"Library",danger:1,tags:["residential"],names:["Public Library","Carnegie Library","Westside Branch","Downtown Library","Heritage Library","Maple Street Library","Community Archives","Founders Library","Eastgate Branch","Central Library"]},
{cat:"warehouse",label:"Warehouse",danger:3,tags:["industrial"],names:["Carson Warehouse","Allied Storage","Dock 7 Freight","Metro Logistics","Ironside Storage","Industrial Park B","Cold Storage Co.","Pacific Warehouse","Crown Distribution","Eastport Depot"]}
];
var CITY_FIRST=["Cedar","Maple","Pine","Iron","Stone","Silver","Hawk","Fox","Raven","Wolf","Ash","Elm","Oak","Birch","Copper","Gold","Crystal","Shadow","Storm","Thunder","Haven","Ridge","Hollow","Moss","Thorn","Willow","Falcon","Bear","Eagle","Rust"];
var CITY_SECOND=["falls","creek","ridge","field","vale","port","haven","brook","wood","burg","ton","ford","dale","view","hill","springs","hollow","crest","point","gate","bend","crossing","bluff","landing","stead"];
var CITY_SUFFIX=["","",""," Heights"," Junction"," Station"," Mills"," Corners"];

function genCityName(){return pick(CITY_FIRST)+pick(CITY_SECOND)+pick(CITY_SUFFIX)}

function genZoneSet(){
  // Generate exactly 12 zones ‚Äî one per category, balanced
  var cats=ZONE_TEMPLATES.slice();
  var zones=[];
  // Shuffle categories
  for(var i=cats.length-1;i>0;i--){var j=Math.floor(Math.random()*(i+1));var t=cats[i];cats[i]=cats[j];cats[j]=t}
  // Take all 12 categories (one each)
  cats.forEach(function(tpl){
    var nm=tpl.names[Math.floor(Math.random()*tpl.names.length)];
    zones.push({name:nm,cat:tpl.cat,label:tpl.label,danger:tpl.danger,tags:tpl.tags.slice()});
  });
  return zones;
}

function gZones(list){return list.map(function(z,i){return{id:"z"+i,name:z.name,cat:z.cat,label:z.label,danger:z.danger,tags:z.tags||[],dist:+((.3+Math.random()*3.5).toFixed(1)),status:i<3?"scouted":"unexplored",loot:100,scarcity:50+Math.floor(Math.random()*50),pois:[]}})}
var LOOT=[{name:"Canned Beans",type:"food",uses:2,weight:1},{name:"Bottled Water",type:"water",uses:2,weight:1},{name:"Bandage Roll",type:"medical",uses:2,weight:.5},{name:"Rusty Pipe",type:"weapon",damage:"1d6",weight:3},{name:"Duct Tape",type:"material",mat:"scrap",weight:.5},{name:"Flashlight",type:"tool",weight:1},{name:"Painkillers",type:"medical",uses:3,weight:.2},{name:"Scrap Metal",type:"material",mat:"scrap",weight:2},{name:"Rope (10ft)",type:"tool",weight:2},{name:"Matches",type:"tool",uses:10,weight:.1},{name:"Wood Planks",type:"material",mat:"wood",weight:4},{name:"Cloth Scraps",type:"material",mat:"cloth",weight:1},{name:"Nails (box)",type:"material",mat:"scrap",weight:1},{name:"Antibiotics",type:"medical",uses:2,weight:.2},{name:"Ammo (pistol)",type:"ammo",uses:6,weight:.5},{name:"Fuel Can",type:"material",mat:"fuel",weight:3}];

// Base building recipes
var RECIPES=[
{id:"barricade",name:"Barricade",desc:"+1 Defense",cost:{wood:3,scrap:2},effect:{defense:1},time:1},
{id:"water_collector",name:"Rain Collector",desc:"+1 water/day",cost:{scrap:4,cloth:2},effect:{waterPerDay:1},time:2},
{id:"food_storage",name:"Food Storage",desc:"+5 food capacity",cost:{wood:4,scrap:1},effect:{foodCap:5},time:1},
{id:"med_station",name:"Med Station",desc:"Heal +2 HP on rest",cost:{scrap:3,cloth:3},effect:{restHeal:2},time:2},
{id:"watchtower",name:"Watchtower",desc:"+2 Defense, spot threats",cost:{wood:6,scrap:4},effect:{defense:2,spotBonus:2},time:3},
{id:"workshop",name:"Workshop",desc:"Craft better weapons",cost:{scrap:6,wood:4},effect:{craftTier:1},time:3}
];

// Enemy templates
var ENEMIES=[
{id:"shambler",name:"Shambler",hp:6,atk:2,def:0,spd:1,xp:5,behavior:"rush",desc:"Slow, rotting, relentless."},
{id:"runner",name:"Runner",hp:8,atk:4,def:1,spd:4,xp:10,behavior:"rush",desc:"Fast and furious. No hesitation."},
{id:"crawler",name:"Crawler",hp:3,atk:3,def:0,spd:1,xp:3,behavior:"ambush",desc:"Low and hidden. Trip hazard."},
{id:"screamer",name:"Screamer",hp:4,atk:1,def:0,spd:2,xp:8,behavior:"flee",desc:"One shriek brings the horde."},
{id:"bloater",name:"Bloater",hp:18,atk:6,def:3,spd:1,xp:20,behavior:"rush",desc:"Massive. Throws bile."},
{id:"hunter",name:"Hunter",hp:10,atk:5,def:2,spd:5,xp:15,behavior:"ambush",desc:"Leaps from shadows."},
{id:"brute",name:"Brute",hp:14,atk:5,def:2,spd:2,xp:12,behavior:"rush",desc:"Thick and strong."},
{id:"raider",name:"Raider",hp:10,atk:4,def:2,spd:3,xp:12,behavior:"ranged",desc:"Human. Armed. Dangerous."}
];

// Travel events
var TRAVEL_EVENTS=[
{type:"ambush",weight:30,desc:"Zombies burst from a doorway!",combat:true},
{type:"cache",weight:15,desc:"You find a hidden stash in an overturned car.",loot:true},
{type:"survivor",weight:10,desc:"A lone survivor waves you down."},
{type:"storm",weight:10,desc:"A sudden storm forces you to take shelter.",timeCost:1},
{type:"clear",weight:35,desc:"The route is quiet. Almost too quiet."}
];

// LOCAL AI ENGINE (Wllama - llama.cpp in WebAssembly)
// Detect mobile for model recommendations
var IS_MOBILE=/Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);

var LOCAL_MODELS=[
{id:"smollm2-1.7b",name:"SmolLM2 1.7B",icon:"üß†",badge:IS_MOBILE?"":"REC",badgeColor:"var(--accent-green)",desc:IS_MOBILE?"Large model. May be slow on mobile.":"Best balance. 1.06 GB download.",size:"1.06 GB",
 hfRepo:"HuggingFaceTB/SmolLM2-1.7B-Instruct-GGUF",hfFile:"smollm2-1.7b-instruct-q4_k_m.gguf"},
{id:"smollm2-360m",name:"SmolLM2 360M",icon:"‚ö°",badge:IS_MOBILE?"REC":"TINY",badgeColor:IS_MOBILE?"var(--accent-green)":"var(--accent-amber)",desc:IS_MOBILE?"Recommended for mobile. Fast and light.":"Ultra-fast. 229 MB. Brief narration.",size:"229 MB",
 hfRepo:"HuggingFaceTB/SmolLM2-360M-Instruct-GGUF",hfFile:"smollm2-360m-instruct-q4_k_m.gguf"}
];
var wllamaEngine=null;
var aiStatus="none"; // none | downloading | loading | ready | error
var aiProgress=0;
var aiModelId=null;
// ============================================================
// STATE & SEEDED RNG
// ============================================================
var S={theme:null,themeMode:'preset',customConfig:{},diff:"survival",pace:"slow",localModel:IS_MOBILE?"smollm2-360m":"smollm2-1.7b",loc:null,zones:[],cName:"",cBg:null,cAttr:null,companions:[],gs:null};
var sbOpen=false,curTab="party",curThemeTab="presets",curPresetFilter="all",inCombat=false,combatState=null;
var undoStack=[];var MAX_UNDO=10;var debugOpen=false;
var deferredInstallPrompt=null;

// Seeded RNG (mulberry32)
function seedRNG(s){return function(){s|=0;s=s+0x6D2B79F5|0;var t=Math.imul(s^s>>>15,1|s);t^=t+Math.imul(t^t>>>7,61|t);return((t^t>>>14)>>>0)/4294967296}}
var gameSeed=Date.now(),rng=seedRNG(gameSeed);

// Builder state
var builderSelections={origin:null,vector:[],speed:null,types:[],intelligence:null,senses:{sight:null,sound:null,smell:null,hive:null},decay:null,horde:null,cure:null,collapse:null,nonHuman:[],environment:[],evolution:null,drives:null,sounds:[],mobility:null,scarcity:70,toneName:"",toneKeywords:""};

// ============================================================
// UTILITY
// ============================================================
function $(id){return document.getElementById(id)}
function rollD20(){return 1+Math.floor(Math.random()*20)}
function rollD6(){return 1+Math.floor(Math.random()*6)}
function getMod(s){return Math.floor((s-10)/2)}
function roll4d6(){var r=[rollD6(),rollD6(),rollD6(),rollD6()];r.sort(function(a,b){return b-a});return{rolls:r,total:r[0]+r[1]+r[2]}}
function rollDice(str){var m=str.match(/(\d+)d(\d+)/);if(!m)return 0;var n=parseInt(m[1]),d=parseInt(m[2]),t=0;for(var i=0;i<n;i++)t+=1+Math.floor(Math.random()*d);return t}
function gZones(list){return list.map(function(z,i){return{id:"z"+i,name:z.name,cat:z.cat,label:z.label,danger:z.danger,tags:z.tags||[],dist:+((.3+Math.random()*3.5).toFixed(1)),status:i<3?"scouted":"unexplored",loot:100,scarcity:50+Math.floor(Math.random()*50),pois:[]}})}
function gLoot(){var n=1+Math.floor(Math.random()*3),items=[];for(var i=0;i<n;i++){var t=LOOT[Math.floor(Math.random()*LOOT.length)];items.push({id:"l"+Date.now()+"_"+i,name:t.name,type:t.type,uses:t.uses,damage:t.damage,weight:t.weight,mat:t.mat})}return items}
function pick(arr){return arr[Math.floor(Math.random()*arr.length)]}
function pickN(arr,n){var c=arr.slice(),r=[];for(var i=0;i<Math.min(n,c.length);i++){var idx=Math.floor(Math.random()*c.length);r.push(c.splice(idx,1)[0])}return r}
function clamp(v,lo,hi){return Math.max(lo,Math.min(hi,v))}
function deepClone(o){return JSON.parse(JSON.stringify(o))}
function timeAgo(ts){var d=Date.now()-ts,s=Math.floor(d/1000);if(s<60)return s+"s ago";if(s<3600)return Math.floor(s/60)+"m ago";if(s<86400)return Math.floor(s/3600)+"h ago";return Math.floor(s/86400)+"d ago"}

// ============================================================
// SAVE / LOAD SYSTEM (localStorage)
// ============================================================
var SAVE_KEY="gz_saves";var AUTOSAVE_KEY="gz_autosave";var SETTINGS_KEY="gz_settings";

function getSaves(){try{return JSON.parse(localStorage.getItem(SAVE_KEY))||{}}catch(e){return{}}}
function setSaves(saves){localStorage.setItem(SAVE_KEY,JSON.stringify(saves))}
function getAutosaves(){try{return JSON.parse(localStorage.getItem(AUTOSAVE_KEY))||[]}catch(e){return[]}}
function setAutosaves(arr){localStorage.setItem(AUTOSAVE_KEY,JSON.stringify(arr))}
function saveSettings(){localStorage.setItem(SETTINGS_KEY,JSON.stringify({localModel:S.localModel}))}
function loadSettings(){try{var s=JSON.parse(localStorage.getItem(SETTINGS_KEY));if(s){S.localModel=s.localModel||S.localModel}}catch(e){}}

function saveToSlot(slot,name){
  var saves=getSaves();
  saves[slot]={name:name||("Day "+S.gs.day+" ‚Äî "+getLeader().name),state:deepClone(S.gs),localModel:S.localModel,ts:Date.now(),version:SCHEMA_VERSION};
  setSaves(saves);saveSettings();
  dbgLog("Saved to slot "+slot);
}

function loadFromSlot(slot){
  var saves=getSaves();var save=saves[slot];
  if(!save)return false;
  var gs=validateGameState(save.state);
  if(save.localModel)S.localModel=save.localModel;
  S.gs=gs;return true;
}

function autoSave(){
  if(!S.gs)return;
  var arr=getAutosaves();
  arr.unshift({state:deepClone(S.gs),ts:Date.now(),turn:S.gs.turns});
  if(arr.length>MAX_UNDO)arr=arr.slice(0,MAX_UNDO);
  setAutosaves(arr);
}

function undoLastTurn(){
  var arr=getAutosaves();
  if(arr.length<2){addNar("[No previous turn to undo.]");return}
  arr.shift(); // remove current
  S.gs=validateGameState(arr[0].state);
  setAutosaves(arr);
  updateHUD();renderSB();buildActs();
  addNar("[‚Ü© Reverted to turn "+S.gs.turns+"]");
}

function exportSave(){
  if(!S.gs)return;
  var data=JSON.stringify({version:SCHEMA_VERSION,state:S.gs,localModel:S.localModel,ts:Date.now()},null,2);
  // Copy to clipboard
  navigator.clipboard.writeText(data).then(function(){
    showMsg("Save copied to clipboard!");
  }).catch(function(){
    showMsg("Clipboard failed ‚Äî use download instead.");
  });
  // Also trigger download
  var blob=new Blob([data],{type:"application/json"});
  var a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="ground-zero-save-"+getLeader().name.replace(/\s/g,"_")+".json";
  a.click();
}

function importSave(json){
  try{
    var data=JSON.parse(json);
    if(!data.state||(!data.state.roster&&!data.state.party))throw new Error("Invalid save format");
    S.gs=validateGameState(data.state);
    if(data.localModel)S.localModel=data.localModel;
    go('game');initGameUI();
    showMsg("Save imported! Day "+S.gs.day);
    return true;
  }catch(e){showMsg("Import failed: "+e.message);return false}
}

function hasSaves(){
  var saves=getSaves();
  return Object.keys(saves).length>0||getAutosaves().length>0;
}

// ============================================================
// STATE VALIDATION & MIGRATION
// ============================================================
function validateGameState(gs){
  if(!gs)return null;
  gs.day=gs.day||1;gs.turns=gs.turns||0;gs.threat=gs.threat||0;
  gs.timeOfDay=gs.timeOfDay||"morning";gs.weather=gs.weather||"clear";
  gs.theme=gs.theme||"Unknown Apocalypse";
  gs.themeConfig=gs.themeConfig||{name:"Unknown",tone:"Survival horror",rule:"Standard zombies",scarcity:.7};
  gs.diff=gs.diff||"survival";gs.pace=gs.pace||"slow";
  gs.locName=gs.locName||"Unknown";gs.currentZone=gs.currentZone||"base";
  
  // MIGRATION: v4 (party array) ‚Üí v5 (roster + activePartyIds)
  if(gs.party&&!gs.roster){
    gs.roster=[];
    gs.activePartyIds=[];
    gs.party.forEach(function(ch,i){
      ch.id=ch.id||genCharId();
      ch.status=ch.status||"active";
      ch.assignment=ch.assignment||null;
      ch.zone=ch.zone||gs.currentZone;
      ch.isLeader=(i===0);
      ch.loyalty=ch.loyalty||100;
      ch.relationships=ch.relationships||{};
      ch.joinedDay=ch.joinedDay||1;
      ch.portrait=ch.portrait||"üë§";
      ch.personalGoal=ch.personalGoal||null;
      ch.lastAction=ch.lastAction||null;
      ch.causeOfDeath=ch.causeOfDeath||null;
      gs.roster.push(ch);
      gs.activePartyIds.push(ch.id);
    });
    delete gs.party;
  }
  
  // Ensure roster exists
  if(!gs.roster||!gs.roster.length){
    var fallback=makeCharacter("Survivor","military",{fitness:12,agility:12,endurance:12,wits:10,awareness:10,presence:10},{isLeader:true,loyalty:100});
    gs.roster=[fallback];
    gs.activePartyIds=[fallback.id];
  }
  
  // Validate each roster member
  gs.roster.forEach(function(ch){
    ch.id=ch.id||genCharId();
    ch.hp=clamp(ch.hp||1,0,ch.maxHP||20);
    ch.stamina=clamp(ch.stamina||0,0,ch.maxStamina||10);
    ch.morale=clamp(ch.morale||50,0,100);
    ch.conditions=ch.conditions||[];ch.inventory=ch.inventory||[];
    ch.status=ch.status||"active";
    ch.loyalty=ch.loyalty||50;
    ch.relationships=ch.relationships||{};
    ch.portrait=ch.portrait||"üë§";
    if(!ch.skills)ch.skills={};
    ASKILLS.forEach(function(s){if(!ch.skills[s])ch.skills[s]={rank:0,xp:0}});
  });
  
  // Ensure activePartyIds valid
  if(!gs.activePartyIds||!gs.activePartyIds.length){
    gs.activePartyIds=[gs.roster[0].id];
  }
  
  // Turn order
  gs.turnOrder=gs.turnOrder||gs.activePartyIds.slice();
  gs.currentActorIndex=gs.currentActorIndex||0;
  gs.interventionQueue=gs.interventionQueue||[];
  gs.eventLog=gs.eventLog||[];
  gs.recruitPool=gs.recruitPool||[];
  
  // Base
  if(!gs.base)gs.base={tier:1,food:5,water:4,medical:2,defense:1,pop:1};
  gs.base.structures=gs.base.structures||[];
  gs.base.materials=gs.base.materials||{wood:0,scrap:0,cloth:0,fuel:0};
  gs.base.waterPerDay=gs.base.waterPerDay||0;
  gs.base.foodCap=gs.base.foodCap||20;
  gs.base.restHeal=gs.base.restHeal||0;
  gs.base.assignments=gs.base.assignments||{};
  gs.base.morale=gs.base.morale||50;
  gs.base.pop=getAliveRoster()?getAliveRoster().length:gs.roster.length;
  
  // Zones
  if(!gs.zones||!gs.zones.length)gs.zones=gZones(genZoneSet());
  gs.zones.forEach(function(z){z.tags=z.tags||[];z.scarcity=z.scarcity||50;z.pois=z.pois||[]});
  gs.memory=gs.memory||[];
  gs.schemaVersion=SCHEMA_VERSION;
  return gs;
}

// ============================================================
// NAVIGATION
// ============================================================
function go(s){
  document.querySelectorAll('.screen').forEach(function(e){e.classList.remove('active')});
  $(s+'-screen').classList.add('active');$(s+'-screen').scrollTop=0;
  if(s==='theme')initTheme();if(s==='diff')initDiff();if(s==='char')initChar();
  if(s==='loc'&&S.zones.length>0)renderZones();
}

// ============================================================
// THEME SCREEN
// ============================================================
function switchThemeTab(tab){
  curThemeTab=tab;
  document.querySelectorAll('.theme-tab').forEach(function(t,i){t.classList.toggle('active',['presets','create','random'][i]===tab)});
  document.querySelectorAll('.theme-panel').forEach(function(p){p.classList.remove('active')});
  $('tab-'+tab).classList.add('active');
  if(tab==='create')initBuilder();
  updateThemeNext();
}
function updateThemeNext(){
  if(curThemeTab==='presets')$('theme-next').disabled=!S.theme;
  else if(curThemeTab==='create')$('theme-next').disabled=!builderSelections.origin;
  else if(curThemeTab==='random')$('theme-next').disabled=!S.randomConfig;
}
function initTheme(){
  if($('preset-list').children.length>0)return;
  var cats=[{id:'all',label:'All'},{id:'film',label:'üé¨ Film'},{id:'tv',label:'üì∫ TV'},{id:'game',label:'üéÆ Game'},{id:'book',label:'üìñ Book'}];
  var fh='';cats.forEach(function(c){fh+='<button class="preset-filter'+(c.id==='all'?' active':'')+'" onclick="filterPresets(\''+c.id+'\')">'+c.label+'</button>'});
  $('preset-filters').innerHTML=fh;renderPresets();
}
function filterPresets(cat){
  curPresetFilter=cat;
  document.querySelectorAll('.preset-filter').forEach(function(f,i){
    f.classList.toggle('active',['all','film','tv','game','book'][i]===cat);
  });
  renderPresets();
}
function renderPresets(){
  var filtered=curPresetFilter==='all'?PRESETS:PRESETS.filter(function(p){return p.category===curPresetFilter});
  var h='';filtered.forEach(function(p){
    var catIcon={film:'üé¨',tv:'üì∫',game:'üéÆ',book:'üìñ'}[p.category]||'';
    h+='<div class="preset-card'+(S.theme===p.id?' sel':'')+'" onclick="selPreset(\''+p.id+'\')" style="border-left-color:'+(S.theme===p.id?p.color:'transparent')+'">';
    h+='<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:4px"><strong style="font-size:15px">'+p.name+'</strong><span class="source-badge">'+catIcon+' '+p.category+'</span></div>';
    h+='<div style="font-size:12px;color:var(--accent-amber);font-style:italic;margin-bottom:6px">'+p.tag+'</div>';
    h+='<div style="font-size:12px;color:var(--text-secondary);line-height:1.4">'+p.desc+'</div>';
    if(S.theme===p.id)h+='<div style="margin-top:8px;padding-top:8px;border-top:1px solid var(--border);font-size:10px;color:var(--text-dim)"><span class="mono" style="color:var(--accent-green)">‚úì SELECTED</span> ‚Äî '+p.rule+'</div>';
    h+='</div>';
  });
  $('preset-list').innerHTML=h;
}
function selPreset(id){S.theme=id;S.themeMode='preset';S.randomConfig=null;renderPresets();updateThemeNext()}

// Builder (unchanged logic, fixed typos)
var builderInited=false;
function initBuilder(){
  if(builderInited)return;builderInited=true;
  var cats=[
    {id:'origin',title:'üß¨ Origin & Cause',desc:'What created the outbreak?',type:'dropdown',options:Object.keys(ZDB.origins)},
    {id:'vector',title:'ü¶† Infection Vectors',desc:'How does it spread?',type:'multi',options:ZDB.vectors.map(function(v){return v.type}).filter(function(v,i,a){return a.indexOf(v)===i})},
    {id:'speed',title:'‚è±Ô∏è Infection Speed',desc:'How fast does it take hold?',type:'dropdown',options:ZDB.speedCategories.map(function(s){return s.label})},
    {id:'types',title:'üíÄ Zombie Types',desc:'What kinds of undead roam?',type:'multi',options:ZDB.zombieTypes.map(function(t){return t.name})},
    {id:'intelligence',title:'üß† Zombie Intelligence',desc:'How smart are they?',type:'slider',min:0,max:6,labels:ZDB.intelligenceLevels},
    {id:'mobility',title:'üèÉ Speed & Mobility',desc:'How fast can they move?',type:'multi',options:ZDB.mobilityClasses},
    {id:'senses',title:'üëÅÔ∏è Zombie Senses',desc:'How do they detect prey?',type:'senses'},
    {id:'drives',title:'üéØ Drives & Motivation',desc:'What compels them?',type:'dropdown',options:ZDB.driveTypes},
    {id:'sounds',title:'üîä Communication & Sound',desc:'What noises do they make?',type:'multi',options:ZDB.soundTypes},
    {id:'decay',title:'‚è≥ Decay & Lifespan',desc:'Do they rot?',type:'dropdown',options:ZDB.decayRates},
    {id:'evolution',title:'üìà Evolution & Mutation',desc:'Do they change over time?',type:'dropdown',options:ZDB.evolutionTypes},
    {id:'horde',title:'üî• Horde Behavior',desc:'How do groups act?',type:'dropdown',options:ZDB.hordeBehaviors},
    {id:'cure',title:'üíâ Cure & Reversal',desc:'Is there hope?',type:'dropdown',options:ZDB.cureStatuses},
    {id:'collapse',title:'üèöÔ∏è Societal Collapse',desc:'How fast did civilization fall?',type:'dropdown',options:ZDB.collapseTimelines},
    {id:'nonHuman',title:'üêï Non-Human Infection',desc:'Can animals be infected?',type:'multi',options:ZDB.nonHumanHosts},
    {id:'environment',title:'üå°Ô∏è Environmental Factors',desc:'How does the world shape the threat?',type:'multi',options:ZDB.environmentalFactors},
    {id:'scarcity',title:'üì¶ Resource Scarcity',desc:'How much is left?',type:'range',min:10,max:100,leftLabel:'Barren Wasteland',rightLabel:'Well Stocked'},
    {id:'tone',title:'üé≠ Tone & Atmosphere',desc:'What does your apocalypse feel like?',type:'tone'}
  ];
  var h='';
  cats.forEach(function(cat){
    h+='<div class="builder-cat" id="bcat-'+cat.id+'"><div class="builder-header" onclick="toggleBuilder(\''+cat.id+'\')"><div><div style="font-weight:600;font-size:13px">'+cat.title+'</div><div class="dim" style="font-size:11px">'+cat.desc+'</div></div><div style="display:flex;align-items:center;gap:8px"><span class="builder-val dim" id="bval-'+cat.id+'" style="font-size:10px;max-width:120px;text-align:right;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></span><span class="chevron">‚ñ∂</span></div></div><div class="builder-body">';
    if(cat.type==='dropdown'){
      h+='<div style="display:flex;flex-wrap:wrap;gap:4px">';cat.options.forEach(function(opt){h+='<span class="builder-tag" data-cat="'+cat.id+'" data-val="'+opt+'" onclick="builderSelect(\''+cat.id+'\',\''+opt.replace(/'/g,"\\'")+'\')">'+opt+'</span>'});h+='</div>';
    }else if(cat.type==='multi'){
      h+='<div style="display:flex;flex-wrap:wrap;gap:4px">';cat.options.forEach(function(opt){h+='<span class="builder-tag" data-cat="'+cat.id+'" data-val="'+opt+'" onclick="builderMulti(\''+cat.id+'\',\''+opt.replace(/'/g,"\\'")+'\')">'+opt+'</span>'});h+='</div>';
    }else if(cat.type==='slider'){
      h+='<div class="range-wrap"><input type="range" min="'+cat.min+'" max="'+cat.max+'" value="0" oninput="builderSlider(\''+cat.id+'\',this.value,'+JSON.stringify(cat.labels).replace(/"/g,'&quot;')+')"><div class="range-val" id="bslider-'+cat.id+'">'+cat.labels[0]+'</div></div>';
    }else if(cat.type==='range'){
      h+='<div class="range-wrap"><input type="range" min="'+cat.min+'" max="'+cat.max+'" value="70" oninput="builderRange(\''+cat.id+'\',this.value)"><div class="range-labels"><span>'+cat.leftLabel+'</span><span id="brange-'+cat.id+'">70%</span><span>'+cat.rightLabel+'</span></div></div>';
    }else if(cat.type==='senses'){
      ZDB.senseProfiles.forEach(function(sp){h+='<div style="margin-bottom:8px"><div class="dim" style="font-size:11px;margin-bottom:4px">'+sp.type+'</div><div style="display:flex;flex-wrap:wrap;gap:4px">';sp.levels.forEach(function(lv){h+='<span class="builder-tag" data-cat="sense-'+sp.type.toLowerCase()+'" data-val="'+lv+'" onclick="builderSense(\''+sp.type.toLowerCase()+'\',\''+lv.replace(/'/g,"\\'")+'\')">'+lv+'</span>'});h+='</div></div>'});
    }else if(cat.type==='tone'){
      h+='<div class="mb-8"><input class="input" id="build-tone-name" placeholder="Name your apocalypse..." oninput="builderTone()" style="font-size:13px"></div><div><input class="input" id="build-tone-kw" placeholder="Tone keywords: grim, comedic, military thriller..." oninput="builderTone()" style="font-size:13px"></div>';
    }
    h+='</div></div>';
  });
  $('builder-cats').innerHTML=h;
}
function toggleBuilder(id){$('bcat-'+id).classList.toggle('open')}
function builderSelect(cat,val){builderSelections[cat]=val;document.querySelectorAll('[data-cat="'+cat+'"]').forEach(function(t){t.classList.toggle('sel',t.getAttribute('data-val')===val)});$('bval-'+cat).textContent=val;S.themeMode='custom';updateThemeNext();updateBuildSummary()}
function builderMulti(cat,val){if(!Array.isArray(builderSelections[cat]))builderSelections[cat]=[];var arr=builderSelections[cat],idx=arr.indexOf(val);if(idx>=0)arr.splice(idx,1);else arr.push(val);document.querySelectorAll('[data-cat="'+cat+'"]').forEach(function(t){t.classList.toggle('sel',arr.indexOf(t.getAttribute('data-val'))>=0)});$('bval-'+cat).textContent=arr.length?arr.length+' selected':'';S.themeMode='custom';updateThemeNext();updateBuildSummary()}
function builderSlider(cat,val,labels){builderSelections[cat]=parseInt(val);var lbl=labels[parseInt(val)]||val;$('bslider-'+cat).textContent=lbl;$('bval-'+cat).textContent=lbl;S.themeMode='custom';updateThemeNext();updateBuildSummary()}
function builderRange(cat,val){builderSelections[cat]=parseInt(val);$('brange-'+cat).textContent=val+'%';$('bval-'+cat).textContent=val+'%';S.themeMode='custom';updateThemeNext();updateBuildSummary()}
function builderSense(sense,val){builderSelections.senses[sense]=val;document.querySelectorAll('[data-cat="sense-'+sense+'"]').forEach(function(t){t.classList.toggle('sel',t.getAttribute('data-val')===val)});$('bval-senses').textContent=Object.values(builderSelections.senses).filter(Boolean).length+' set';S.themeMode='custom';updateThemeNext();updateBuildSummary()}
function builderTone(){builderSelections.toneName=$('build-tone-name')?$('build-tone-name').value:'';builderSelections.toneKeywords=$('build-tone-kw')?$('build-tone-kw').value:'';$('bval-tone').textContent=builderSelections.toneName||'';S.themeMode='custom';updateBuildSummary()}
function updateBuildSummary(){var b=builderSelections,rows=[];if(b.origin)rows.push(['Origin',b.origin]);if(b.vector&&b.vector.length)rows.push(['Vectors',b.vector.join(', ')]);if(b.speed)rows.push(['Speed',b.speed]);if(b.types&&b.types.length)rows.push(['Types',b.types.join(', ')]);if(b.intelligence!==null&&b.intelligence!==undefined)rows.push(['Intelligence',ZDB.intelligenceLevels[b.intelligence]||'']);if(b.decay)rows.push(['Decay',b.decay]);if(b.horde)rows.push(['Horde',b.horde]);if(b.cure)rows.push(['Cure',b.cure]);if(rows.length){$('build-summary').style.display='block';var h='';rows.forEach(function(r){h+='<div class="summary-row"><span class="summary-label">'+r[0]+'</span><span class="summary-value">'+r[1]+'</span></div>'});$('summary-rows').innerHTML=h}else{$('build-summary').style.display='none'}}

// Random Apocalypse
function rollRandomApocalypse(){
  var results=[],cfg={};
  var originKeys=Object.keys(ZDB.origins);cfg.origin=pick(originKeys);var originEntry=pick(ZDB.origins[cfg.origin]);
  results.push({label:'Origin',value:cfg.origin+' ‚Äî '+originEntry.subType,detail:originEntry.desc});
  var allVectors=ZDB.vectors.map(function(v){return v.type}).filter(function(v,i,a){return a.indexOf(v)===i});
  cfg.vectors=pickN(allVectors,1+Math.floor(Math.random()*3));results.push({label:'Infection',value:cfg.vectors.join(', ')});
  cfg.speed=pick(ZDB.speedCategories);results.push({label:'Speed',value:cfg.speed.label,detail:cfg.speed.details});
  cfg.types=pickN(ZDB.zombieTypes,2+Math.floor(Math.random()*3));results.push({label:'Zombie Types',value:cfg.types.map(function(t){return t.name}).join(', ')});
  var intIdx=Math.floor(Math.random()*ZDB.intelligenceLevels.length);cfg.intelligence=intIdx;results.push({label:'Intelligence',value:ZDB.intelligenceLevels[intIdx]});
  cfg.mobility=pickN(ZDB.mobilityClasses,1+Math.floor(Math.random()*2));results.push({label:'Mobility',value:cfg.mobility.join(', ')});
  var senseChoices=[];ZDB.senseProfiles.forEach(function(sp){senseChoices.push(sp.type+': '+pick(sp.levels))});cfg.senses=senseChoices;results.push({label:'Senses',value:senseChoices.join(' | ')});
  cfg.drives=pick(ZDB.driveTypes);results.push({label:'Drives',value:cfg.drives});
  cfg.sounds=pickN(ZDB.soundTypes,1+Math.floor(Math.random()*2));results.push({label:'Sounds',value:cfg.sounds.join(', ')});
  cfg.decay=pick(ZDB.decayRates);results.push({label:'Decay',value:cfg.decay});
  cfg.evolution=pick(ZDB.evolutionTypes);results.push({label:'Evolution',value:cfg.evolution});
  cfg.horde=pick(ZDB.hordeBehaviors);results.push({label:'Horde',value:cfg.horde});
  cfg.cure=pick(ZDB.cureStatuses);results.push({label:'Cure',value:cfg.cure});
  cfg.collapse=pick(ZDB.collapseTimelines);results.push({label:'Collapse',value:cfg.collapse});
  cfg.nonHuman=pickN(ZDB.nonHumanHosts,Math.floor(Math.random()*3));if(cfg.nonHuman.length)results.push({label:'Animals',value:cfg.nonHuman.join(', ')});
  cfg.environment=pickN(ZDB.environmentalFactors,1+Math.floor(Math.random()*2));results.push({label:'Environment',value:cfg.environment.join(', ')});
  cfg.scarcity=20+Math.floor(Math.random()*80);results.push({label:'Scarcity',value:cfg.scarcity+'% resources'});
  var h='<div class="mono dim mb-8" style="font-size:10px;letter-spacing:2px;text-align:center">FATE HAS SPOKEN</div>';
  results.forEach(function(r,i){h+='<div class="slot-result" style="animation-delay:'+(i*0.08)+'s;animation-fill-mode:backwards"><div><span class="dim" style="font-size:10px">'+r.label+'</span><div style="font-size:13px;font-weight:500">'+r.value+'</div>'+(r.detail?'<div style="font-size:10px;color:var(--text-dim);margin-top:2px">'+r.detail+'</div>':'')+'</div></div>'});
  $('random-results').innerHTML=h;S.randomConfig=cfg;S.themeMode='random';S.theme='random_roll';updateThemeNext();
}

// Theme Continue
function themeNext(){
  if(S.themeMode==='preset'){var preset=PRESETS.find(function(p){return p.id===S.theme});if(!preset)return;S.themeConfig={name:preset.name,tone:preset.tone,rule:preset.rule,scarcity:preset.scarcity,config:preset.config}}
  else if(S.themeMode==='custom'){var b=builderSelections,name=b.toneName||'Custom Apocalypse',tone=b.toneKeywords||'Survival horror',rules=[];
    if(b.origin)rules.push('Origin: '+b.origin);if(b.vector&&b.vector.length)rules.push('Spreads via: '+b.vector.join(', '));if(b.speed)rules.push('Speed: '+b.speed);if(b.cure)rules.push('Cure: '+b.cure);if(b.types&&b.types.length)rules.push('Threats: '+b.types.join(', '));if(b.intelligence!==null)rules.push('Intelligence: '+ZDB.intelligenceLevels[b.intelligence]);if(b.horde)rules.push('Horde: '+b.horde);if(b.decay)rules.push('Decay: '+b.decay);if(b.drives)rules.push('Drives: '+b.drives);
    S.themeConfig={name:name,tone:tone,rule:rules.join('. '),scarcity:b.scarcity/100,config:b}}
  else if(S.themeMode==='random'){var c=S.randomConfig;if(!c)return;var rules=['Origin: '+c.origin,'Vectors: '+c.vectors.join(', '),'Speed: '+c.speed.label,'Types: '+c.types.map(function(t){return t.name}).join(', '),'Intelligence: '+ZDB.intelligenceLevels[c.intelligence],'Horde: '+c.horde,'Cure: '+c.cure,'Collapse: '+c.collapse];
    if(c.nonHuman.length)rules.push('Animals: '+c.nonHuman.join(', '));rules.push('Environment: '+c.environment.join(', '));
    S.themeConfig={name:"Fate's Apocalypse",tone:'Unpredictable chaos. Every rule remixed.',rule:rules.join('. '),scarcity:c.scarcity/100,config:c}}
  go('diff');
}

// Difficulty & Provider selection
function initDiff(){var dl=$('diff-list'),pl=$('pace-list');if(!dl.children.length){var h='';DIFFS.forEach(function(d){h+='<div class="card'+(S.diff===d.id?' sel':'')+'" data-d="'+d.id+'" onclick="selDiff(\''+d.id+'\')"><div style="display:flex;justify-content:space-between;align-items:center"><div><strong>'+d.name+'</strong>'+(d.rec?'<span style="margin-left:8px;font-size:10px;color:var(--accent-green);border:1px solid var(--accent-green);padding:1px 5px;border-radius:3px">REC</span>':'')+'<div class="sec" style="font-size:12px;margin-top:3px">'+d.desc+'</div></div>'+(S.diff===d.id?'<span style="color:var(--accent-green)">‚úì</span>':'')+'</div></div>'});dl.innerHTML=h;h='';PACES.forEach(function(p){h+='<div class="card'+(S.pace===p.id?' sel':'')+'" data-p="'+p.id+'" onclick="selPace(\''+p.id+'\')"><div style="display:flex;justify-content:space-between;align-items:center"><div><strong>'+p.name+'</strong>'+(p.rec?'<span style="margin-left:8px;font-size:10px;color:var(--accent-green);border:1px solid var(--accent-green);padding:1px 5px;border-radius:3px">REC</span>':'')+'<div class="sec" style="font-size:12px;margin-top:3px">'+p.desc+'</div></div>'+(S.pace===p.id?'<span style="color:var(--accent-green)">‚úì</span>':'')+'</div></div>'});pl.innerHTML=h}renderModelPicker()}
function renderModelPicker(){var h='';LOCAL_MODELS.forEach(function(m){var sel=S.localModel===m.id;h+='<div class="card'+(sel?' sel':'')+'" onclick="selLocalModel(\''+m.id+'\')" style="text-align:center;padding:14px 10px;border-color:'+(sel?'var(--accent-blue)':'var(--border)')+'"><div style="font-size:20px;margin-bottom:4px">'+m.icon+'</div><div style="font-weight:700;font-size:13px">'+m.name+'</div>'+(m.badge?'<span style="font-size:10px;color:'+m.badgeColor+';border:1px solid '+m.badgeColor+';padding:1px 5px;border-radius:3px">'+m.badge+'</span>':'')+'<div class="dim" style="font-size:10px;margin-top:4px;line-height:1.3">'+m.desc+'</div>'+(sel?'<div style="margin-top:6px;color:var(--accent-blue);font-size:10px;font-weight:600">‚úì SELECTED</div>':'')+'</div>'});$('model-list').innerHTML=h;$('ai-download-area').style.display='block';updateAIStatus()}
function selLocalModel(id){S.localModel=id;renderModelPicker();saveSettings()}
function updateAIStatus(){var el=$('ai-dl-status'),bar=$('ai-dl-bar'),btn=$('ai-dl-btn');if(!el)return;var m=LOCAL_MODELS.find(function(x){return x.id===S.localModel});if(aiStatus==='ready'&&aiModelId===S.localModel){el.textContent='‚úì '+m.name+' loaded and ready!';el.style.color='var(--accent-green)';bar.style.width='100%';bar.style.background='var(--accent-green)';btn.textContent='‚úì Ready';btn.disabled=true}else if(aiStatus==='downloading'){el.textContent='Downloading '+m.name+'... '+aiProgress+'%';el.style.color='var(--accent-blue)';bar.style.width=aiProgress+'%';btn.textContent='Downloading...';btn.disabled=true}else if(aiStatus==='loading'){el.textContent='Loading model into memory...';el.style.color='var(--accent-amber)';bar.style.width='100%';bar.style.background='var(--accent-amber)';btn.textContent='Loading...';btn.disabled=true}else if(aiStatus==='error'){el.textContent='Error loading model. Try again or skip.';el.style.color='var(--accent-red)';btn.textContent='‚¨á Retry Download';btn.disabled=false}else if(RESTRICTED_ORIGIN){el.textContent='AI requires HTTPS origin (GitHub Pages / web server)';el.style.color='var(--text-dim)';bar.style.width='0%';btn.textContent='‚¨á Download Model';btn.disabled=false}else{el.textContent=m.name+' ‚Äî '+m.size+' download (one-time)';el.style.color='var(--text-secondary)';bar.style.width='0%';bar.style.background='var(--accent-blue)';btn.textContent='‚¨á Download Model';btn.disabled=false}}
function skipAI(){showMsg("Using offline narrator. Full gameplay available!");$('ai-dl-status').textContent='Skipped ‚Äî offline narrator active';$('ai-dl-status').style.color='var(--text-dim)'}
function selDiff(id){S.diff=id;document.querySelectorAll('#diff-list .card').forEach(function(c){c.classList.toggle('sel',c.getAttribute('data-d')===id)})}
function selPace(id){S.pace=id;document.querySelectorAll('#pace-list .card').forEach(function(c){c.classList.toggle('sel',c.getAttribute('data-p')===id)})}

// Location
function locMethod(m){$('loc-addr-btn').classList.toggle('sel',m==='addr');$('loc-fic-btn').classList.toggle('sel',m==='fic');if(m==='addr'){$('addr-area').style.display='block';$('fic-status').style.display='none'}else{$('addr-area').style.display='none';$('fic-status').style.display='block';var city=genCityName();S.loc={name:city};S.zones=gZones(genZoneSet());$('fic-city-name').textContent='üèôÔ∏è '+city;renderZones();$('loc-next').disabled=false}}
async function locSearch(){var v=$('loc-input').value.trim();if(!v)return;$('loc-search').disabled=true;$('loc-status').textContent="Searching...";var controller=new AbortController();var timeout=setTimeout(function(){controller.abort()},10000);try{var r=await fetch("https://nominatim.openstreetmap.org/search?format=json&q="+encodeURIComponent(v)+"&limit=1",{headers:{"User-Agent":"GroundZero/1.0"},signal:controller.signal});clearTimeout(timeout);var d=await r.json();if(d.length>0){var lat=parseFloat(d[0].lat),lng=parseFloat(d[0].lon);S.loc={name:v,lat:lat,lng:lng};$('loc-status').textContent="Found! Scanning POIs...";try{var q='[out:json][timeout:10];(node["shop"="supermarket"](around:4000,'+lat+','+lng+');node["amenity"="pharmacy"](around:4000,'+lat+','+lng+');node["amenity"="hospital"](around:4000,'+lat+','+lng+');node["amenity"="fuel"](around:4000,'+lat+','+lng+');node["amenity"="police"](around:4000,'+lat+','+lng+');node["amenity"="fire_station"](around:4000,'+lat+','+lng+');node["amenity"="school"](around:4000,'+lat+','+lng+');node["amenity"="library"](around:4000,'+lat+','+lng+');node["amenity"="place_of_worship"](around:4000,'+lat+','+lng+');node["leisure"="park"](around:4000,'+lat+','+lng+');node["shop"="hardware"](around:4000,'+lat+','+lng+');node["shop"="doityourself"](around:4000,'+lat+','+lng+');node["building"="warehouse"](around:4000,'+lat+','+lng+');node["landuse"="industrial"](around:4000,'+lat+','+lng+'););out tags 60;';var c2=new AbortController();var t2=setTimeout(function(){c2.abort()},10000);var r2=await fetch("https://overpass-api.de/api/interpreter",{method:"POST",body:"data="+encodeURIComponent(q),signal:c2.signal});clearTimeout(t2);var d2=await r2.json();
// Categorize results with max per category
var buckets={},seen={};
var catMap=[
{match:function(tg){return tg.shop==="supermarket"},cat:"supermarket",label:"Grocery",danger:2,tags:["food"]},
{match:function(tg){return tg.amenity==="pharmacy"},cat:"pharmacy",label:"Pharmacy",danger:2,tags:["medical"]},
{match:function(tg){return tg.amenity==="hospital"},cat:"hospital",label:"Hospital",danger:4,tags:["medical"]},
{match:function(tg){return tg.amenity==="fuel"},cat:"fuel",label:"Gas Station",danger:3,tags:["fuel"]},
{match:function(tg){return tg.amenity==="police"},cat:"police",label:"Police Station",danger:4,tags:["military"]},
{match:function(tg){return tg.amenity==="fire_station"},cat:"fire_station",label:"Fire Station",danger:2,tags:["industrial"]},
{match:function(tg){return tg.amenity==="school"},cat:"school",label:"School",danger:2,tags:["residential"]},
{match:function(tg){return tg.amenity==="library"},cat:"library",label:"Library",danger:1,tags:["residential"]},
{match:function(tg){return tg.amenity==="place_of_worship"},cat:"church",label:"Church",danger:1,tags:["residential"]},
{match:function(tg){return tg.leisure==="park"},cat:"park",label:"Park",danger:1,tags:["water"]},
{match:function(tg){return tg.shop==="hardware"||tg.shop==="doityourself"},cat:"hardware",label:"Hardware",danger:2,tags:["industrial"]},
{match:function(tg){return tg.building==="warehouse"||tg.landuse==="industrial"},cat:"warehouse",label:"Warehouse",danger:3,tags:["industrial"]}
];
(d2.elements||[]).forEach(function(el){
  var n=el.tags&&el.tags.name;if(!n||seen[n])return;seen[n]=1;var tg=el.tags||{};
  for(var c=0;c<catMap.length;c++){
    var cm=catMap[c];
    if(cm.match(tg)){if(!buckets[cm.cat])buckets[cm.cat]=[];buckets[cm.cat].push({name:n,cat:cm.cat,label:cm.label,danger:cm.danger,tags:cm.tags.slice()});break}
  }
});
// Balance: pick max 2 per category, prioritize variety, target 12
var zz=[];var catsUsed={};
// First pass: one from each category that has results
var catOrder=["supermarket","pharmacy","hospital","hardware","fuel","police","fire_station","school","park","library","warehouse","church"];
catOrder.forEach(function(cat){if(buckets[cat]&&buckets[cat].length>0&&zz.length<12){var pick=buckets[cat].splice(Math.floor(Math.random()*buckets[cat].length),1)[0];zz.push(pick);catsUsed[cat]=1}});
// Second pass: fill to 12 from remaining (max 2 per cat)
if(zz.length<12){catOrder.forEach(function(cat){if(zz.length>=12)return;if(buckets[cat]&&buckets[cat].length>0&&(catsUsed[cat]||0)<2){var pick=buckets[cat].splice(Math.floor(Math.random()*buckets[cat].length),1)[0];zz.push(pick);catsUsed[cat]=(catsUsed[cat]||0)+1}})}
// Third pass: if still under 12, fill gaps with generated zones from missing categories
if(zz.length<12){var missing=catOrder.filter(function(cat){return!catsUsed[cat]});var gen=genZoneSet();gen.forEach(function(gz){if(zz.length>=12)return;if(missing.indexOf(gz.cat)>=0||zz.length<12){var dup=zz.some(function(z){return z.name===gz.name});if(!dup){zz.push(gz);missing=missing.filter(function(m){return m!==gz.cat})}}})}
if(zz.length>0){S.zones=gZones(zz);$('loc-status').textContent="Found "+S.zones.length+" locations near "+v+"!"}else{S.zones=gZones(genZoneSet());$('loc-status').textContent="No POI data ‚Äî generated zones."}}catch(e){S.zones=gZones(genZoneSet());$('loc-status').textContent="POI scan unavailable ‚Äî generated."}}else{S.loc={name:v};S.zones=gZones(genZoneSet());$('loc-status').textContent="Not found ‚Äî generated zones."}}catch(e){S.loc={name:v};S.zones=gZones(genZoneSet());$('loc-status').textContent=e.name==='AbortError'?"Search timed out ‚Äî generated zones.":"Search unavailable ‚Äî generated."}$('loc-search').disabled=false;renderZones();$('loc-next').disabled=false}
function renderZones(){$('zone-area').style.display='block';$('zone-ct').textContent=S.zones.length;var h='';S.zones.forEach(function(z){var dots='';for(var i=1;i<=5;i++)dots+='<span style="display:inline-block;width:5px;height:5px;border-radius:1px;background:'+(i<=z.danger?'var(--accent-red)':'var(--bg-hover)')+';margin-left:2px"></span>';h+='<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:var(--bg-deep);border-radius:4px;margin-bottom:4px;border-left:3px solid '+(z.status==='scouted'?'var(--accent-green)':'var(--text-dim)')+';font-size:12px"><div><span>'+z.name+'</span><span class="dim" style="font-size:10px;margin-left:6px">'+z.label+'</span></div><div>'+dots+'</div></div>'});$('zone-list').innerHTML=h}

// Character
function initChar(){var bl=$('bg-list');if(bl.children.length>0)return;var h='';BGS.forEach(function(bg){h+='<div class="card" data-b="'+bg.id+'" onclick="selBg(\''+bg.id+'\')" style="padding:10px"><div style="display:flex;gap:8px;align-items:flex-start"><span style="font-size:18px;flex-shrink:0;width:24px;text-align:center">'+bg.icon+'</span><div><div style="font-weight:600;font-size:13px">'+bg.name+'</div><div class="serif sec" style="font-size:11px;font-style:italic;margin-top:2px;line-height:1.4">'+bg.flavor+'</div></div></div></div>'});bl.innerHTML=h}
function selBg(id){S.cBg=id;document.querySelectorAll('#bg-list .card').forEach(function(c){c.classList.toggle('sel',c.getAttribute('data-b')===id)});checkReady()}
function doRoll(){var at={},h='';ATTRS.forEach(function(a){var r=roll4d6();at[a.id]=r.total;var m=getMod(r.total);h+='<div style="background:var(--bg-deep);padding:10px;border-radius:6px"><div style="display:flex;justify-content:space-between"><span style="font-weight:600;font-size:13px">'+a.name+'</span><div><span class="mono" style="font-size:18px;font-weight:700">'+r.total+'</span><span class="mono" style="font-size:11px;color:'+(m>=0?'var(--accent-green)':'var(--accent-red)')+';margin-left:3px">'+(m>=0?'+':'')+m+'</span></div></div><div class="dim" style="font-size:10px">'+a.desc+'</div><div class="mono dim" style="font-size:9px;margin-top:2px">rolled: ['+r.rolls.join(', ')+']</div></div>'});S.cAttr=at;$('attr-grid').innerHTML=h;checkReady()}
function doStd(){var arr=[15,14,13,12,10,8],at={},h='';ATTRS.forEach(function(a,i){at[a.id]=arr[i];var m=getMod(arr[i]);h+='<div style="background:var(--bg-deep);padding:10px;border-radius:6px"><div style="display:flex;justify-content:space-between"><span style="font-weight:600;font-size:13px">'+a.name+'</span><div><span class="mono" style="font-size:18px;font-weight:700">'+arr[i]+'</span><span class="mono" style="font-size:11px;color:'+(m>=0?'var(--accent-green)':'var(--accent-red)')+';margin-left:3px">'+(m>=0?'+':'')+m+'</span></div></div><div class="dim" style="font-size:10px">'+a.desc+'</div></div>'});S.cAttr=at;$('attr-grid').innerHTML=h;checkReady()}
function checkReady(){S.cName=$('char-name').value.trim();$('start-btn').disabled=!(S.cName&&S.cBg&&S.cAttr)}

// Random name pools for companions
var COMP_NAMES=["Elena","Joel","Marcus","Diana","Keiko","Ray","Sam","Alex","Morgan","Casey","Avery","Jordan","Riley","Quinn","Reese","Sage","Blake","Drew","Harley","Zane","Mara","Cole","Tess","Niko","Lena","Beck","Rosa","Finn","Ivy","Knox"];

function addCompanion(){
  if(S.companions.length>=2){showMsg("Maximum 2 starting companions.");return}
  var usedNames=[S.cName];S.companions.forEach(function(c){usedNames.push(c.name)});
  var available=COMP_NAMES.filter(function(n){return usedNames.indexOf(n)<0});
  var name=available.length?pick(available):"Survivor "+(S.companions.length+2);
  var bgPool=BGS.filter(function(b){return b.id!==S.cBg});
  var bg=pick(bgPool);
  var attrs=rollRandomAttrs();
  S.companions.push({name:name,bg:bg.id,attrs:attrs});
  renderCompanions();
}

function removeCompanion(idx){
  S.companions.splice(idx,1);
  renderCompanions();
}

function rerollCompanion(idx){
  var comp=S.companions[idx];
  comp.attrs=rollRandomAttrs();
  var bgPool=BGS.filter(function(b){return b.id!==S.cBg});
  comp.bg=pick(bgPool).id;
  renderCompanions();
}

function renderCompanions(){
  var h='';
  S.companions.forEach(function(comp,i){
    var bg=BGS.find(function(b){return b.id===comp.bg});
    var em=getMod(comp.attrs.endurance);
    h+='<div style="padding:10px;background:var(--bg-card);border-radius:6px;margin-bottom:6px;border:1px solid var(--border)">';
    h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px"><div><span style="font-size:14px;margin-right:4px">'+(bg?bg.icon:'üë§')+'</span><strong>'+comp.name+'</strong> <span class="dim" style="font-size:11px">'+(bg?bg.name:'')+'</span></div>';
    h+='<div style="display:flex;gap:4px"><button class="debug-btn" style="font-size:10px;background:var(--accent-amber)" onclick="rerollCompanion('+i+')">üé≤</button><button class="debug-btn" style="font-size:10px;background:var(--accent-red)" onclick="removeCompanion('+i+')">‚úï</button></div></div>';
    h+='<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:2px;font-size:10px">';
    ATTRS.forEach(function(a){var v=comp.attrs[a.id],m=getMod(v);h+='<div><span class="dim">'+a.abbr+'</span> <span class="mono">'+v+'</span><span style="color:'+(m>=0?'var(--accent-green)':'var(--accent-red)')+';font-size:9px">'+(m>=0?'+':'')+m+'</span></div>'});
    h+='</div>';
    h+='<div class="dim" style="font-size:10px;margin-top:4px">HP '+(10+em*2)+' | Stam '+(6+em)+'</div>';
    h+='</div>';
  });
  $('comp-list').innerHTML=h;
  $('add-comp-btn').style.display=S.companions.length>=2?'none':'block';
}
// ============================================================
// START GAME
// ============================================================
function startGame(){
  // Create leader
  var leader=makeCharacter(S.cName,S.cBg,S.cAttr,{
    isLeader:true,status:"active",morale:60,loyalty:100,joinedDay:1,
    inventory:[{id:"s1",name:"Kitchen Knife",type:"weapon",damage:"1d4",weight:1},{id:"s2",name:"Worn Backpack",type:"container",weight:2},{id:"s3",name:"Canned Food",type:"food",uses:3,weight:2},{id:"s4",name:"Water Bottle",type:"water",uses:2,weight:1},{id:"s5",name:"Dirty Bandages",type:"medical",uses:1,weight:.5}]
  });
  
  var roster=[leader];
  var activeIds=[leader.id];
  
  // Add companions
  S.companions.forEach(function(comp){
    var ch=makeCharacter(comp.name,comp.bg,comp.attrs,{
      status:"active",morale:50,loyalty:55,joinedDay:1,
      inventory:[{id:"ci"+roster.length,name:"Worn Knife",type:"weapon",damage:"1d4",weight:1}]
    });
    roster.push(ch);
    activeIds.push(ch.id);
  });
  
  var tc=S.themeConfig;
  var pop=roster.length;
  S.gs={schemaVersion:SCHEMA_VERSION,theme:tc.name,themeConfig:tc,diff:S.diff,pace:S.pace,locName:S.loc?S.loc.name:"Unknown",currentZone:"base",day:1,timeOfDay:"morning",weather:"clear",
    roster:roster,activePartyIds:activeIds,
    turnOrder:activeIds.slice(),currentActorIndex:0,
    interventionQueue:[],eventLog:[],recruitPool:[],
    base:{tier:1,food:3+pop*2,water:2+pop*2,medical:2,defense:1,pop:pop,structures:[],materials:{wood:2,scrap:2,cloth:1,fuel:0},waterPerDay:0,foodCap:20,restHeal:0,morale:50,assignments:{}},
    zones:[{id:"base",name:"Base Camp",cat:"camp",label:"Home Base",danger:0,tags:["safe"],dist:0,status:"scouted",loot:0,scarcity:0,pois:[]}].concat(S.zones.length>0?S.zones:gZones(genZoneSet())),threat:0,turns:0,memory:[],seed:gameSeed};
  go('game');initGameUI();autoSave();
}

// ============================================================
// GAME UI
// ============================================================
function initGameUI(){updateHUD();buildSBTabs();renderSB();buildActs();doOpening()}
function updateHUD(){var g=S.gs,tc={dawn:"#d4a574",morning:"#c8b888",afternoon:"#b8a878",dusk:"#a87858",night:"#4a4a6a"},wi={clear:"‚òÄ",overcast:"‚òÅ",foggy:"üå´",rain:"üåß",storm:"‚õà"};$('hud-day').textContent="Day "+g.day;$('hud-time').textContent=(wi[g.weather]||"")+" "+g.timeOfDay;$('hud-time').style.color=tc[g.timeOfDay]||"var(--text-secondary)";$('hud-threat').textContent="‚ö† "+g.threat;var zn=g.zones.find(function(z){return z.id===g.currentZone});$('hud-loc').textContent=g.currentZone==='base'?'üè† Base':'üìç '+(zn?zn.name:g.currentZone).substring(0,12)}
function toggleSB(){sbOpen=!sbOpen;$('sidebar-overlay').classList.toggle('open',sbOpen);$('sb-toggle').textContent=sbOpen?'‚úï CLOSE':'‚ò∞ INFO'}
function buildSBTabs(){var tabs=["party","skills","base","items","zones","rules","log"],h='';tabs.forEach(function(t){h+='<button class="tab-btn'+(curTab===t?' active':'')+'" onclick="swTab(\''+t+'\')">'+t+'</button>'});$('sb-tabs').innerHTML=h}
function swTab(t){curTab=t;buildSBTabs();renderSB()}
function mBar(l,v,mx,c){var p=mx>0?(v/mx)*100:0;return'<div style="margin-bottom:8px"><div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:3px;color:var(--text-secondary)"><span>'+l+'</span><span class="mono">'+v+'/'+mx+'</span></div><div class="bar-track"><div class="bar-fill" style="width:'+p+'%;background:'+c+'"></div></div></div>'}

function renderSB(){
  var g=S.gs,el=$('sb-content'),h='';
  // Selected character for detail views (skills/items)
  var selCh=getCurrentActor()||getLeader();
  
  if(curTab==="party"){
    // Active Party
    var active=getActiveParty();
    h+='<div class="mono dim" style="font-size:10px;margin-bottom:6px;letter-spacing:2px">ACTIVE PARTY ('+active.length+'/4)</div>';
    active.forEach(function(ch){
      var bg=BGS.find(function(b){return b.id===ch.background});
      var isCur=g.turnOrder&&g.turnOrder[g.currentActorIndex]===ch.id;
      h+='<div style="padding:8px 10px;background:'+(isCur?'var(--bg-active)':'var(--bg-card)')+';border-radius:6px;margin-bottom:4px;border-left:3px solid '+(isCur?'var(--accent-amber)':'var(--border)');
      h+='">';
      h+='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px"><div><span style="font-size:14px;margin-right:4px">'+ch.portrait+'</span><strong style="font-size:13px">'+ch.name+'</strong>';
      if(ch.isLeader)h+=' <span style="font-size:9px;color:var(--accent-amber);border:1px solid var(--accent-amber);padding:0 3px;border-radius:2px">LEADER</span>';
      h+='</div><span class="dim" style="font-size:10px">'+(bg?bg.name:'')+'</span></div>';
      h+=mBar("HP",ch.hp,ch.maxHP,ch.hp/ch.maxHP>.5?"var(--accent-green)":ch.hp/ch.maxHP>.25?"var(--accent-amber)":"var(--accent-red)");
      h+='<div style="display:flex;gap:8px;font-size:10px;color:var(--text-secondary)"><span>Stam '+ch.stamina+'/'+ch.maxStamina+'</span><span>Mor '+ch.morale+'</span>';
      if(!ch.isLeader)h+='<span>Loy '+ch.loyalty+'</span>';
      h+='</div>';
      if(ch.conditions.length)h+='<div style="font-size:10px;color:var(--accent-amber);margin-top:3px">'+ch.conditions.join(', ')+'</div>';
      // Swap button (only at base, not leader)
      if(!ch.isLeader&&g.currentZone==='base')h+='<button class="debug-btn" style="font-size:10px;margin-top:4px;background:var(--text-dim)" onclick="swapToBase(\''+ch.id+'\')">‚Üí Send to Base</button>';
      h+='</div>';
    });
    
    // Base Roster
    var base=getBaseRoster();
    if(base.length){
      h+='<div class="mono dim" style="font-size:10px;margin-top:12px;margin-bottom:6px;letter-spacing:2px">AT BASE ('+base.length+')</div>';
      base.forEach(function(ch){
        var bg=BGS.find(function(b){return b.id===ch.background});
        var asgn=g.base.assignments[ch.id]||"idle";
        h+='<div style="padding:6px 10px;background:var(--bg-card);border-radius:6px;margin-bottom:4px;border-left:3px solid var(--text-dim)">';
        h+='<div style="display:flex;justify-content:space-between;align-items:center"><div><span style="font-size:13px;margin-right:4px">'+ch.portrait+'</span><strong style="font-size:12px">'+ch.name+'</strong></div><span class="dim" style="font-size:10px">'+asgn+'</span></div>';
        h+='<div style="display:flex;gap:8px;font-size:10px;color:var(--text-secondary);margin-top:3px"><span>HP '+ch.hp+'/'+ch.maxHP+'</span><span>Mor '+ch.morale+'</span><span>Loy '+ch.loyalty+'</span></div>';
        if(active.length<4&&g.currentZone==='base')h+='<button class="debug-btn" style="font-size:10px;margin-top:4px;background:var(--accent-blue)" onclick="swapToParty(\''+ch.id+'\')">‚Üí Add to Party</button>';
        h+='</div>';
      });
    }
    
    // Dead
    var dead=g.roster.filter(function(c){return c.status==="dead"});
    if(dead.length){
      h+='<div class="mono dim" style="font-size:10px;margin-top:12px;margin-bottom:6px;letter-spacing:2px">FALLEN ('+dead.length+')</div>';
      dead.forEach(function(ch){
        h+='<div style="padding:4px 10px;font-size:11px;color:var(--text-dim)">üíÄ '+ch.name+(ch.causeOfDeath?' ‚Äî '+ch.causeOfDeath:'')+'</div>';
      });
    }
    
  }else if(curTab==="skills"){
    var bg=BGS.find(function(b){return b.id===selCh.background});
    h+='<div style="font-weight:700;margin-bottom:2px">'+selCh.portrait+' '+selCh.name+'</div><div class="dim" style="font-size:11px;margin-bottom:10px">'+(bg?bg.name:'')+'</div>';
    h+='<div class="mono dim" style="font-size:10px;margin-bottom:6px;letter-spacing:2px">ATTRIBUTES</div><div style="display:grid;grid-template-columns:1fr 1fr;gap:2px;margin-bottom:12px">';
    ATTRS.forEach(function(a){var v=selCh.attrs[a.id],m=getMod(v);h+='<div style="display:flex;justify-content:space-between;font-size:11px;padding:2px 0"><span class="sec">'+a.abbr+'</span><span class="mono">'+v+' <span style="color:'+(m>=0?'var(--accent-green)':'var(--accent-red)')+';font-size:9px">'+(m>=0?'+':'')+m+'</span></span></div>'});h+='</div>';
    h+='<div class="mono dim" style="font-size:10px;margin-bottom:6px;letter-spacing:2px">SKILLS</div>';
    var sorted=ASKILLS.filter(function(s){return selCh.skills[s]&&selCh.skills[s].rank>0}).sort(function(a,b){return(selCh.skills[b].rank||0)-(selCh.skills[a].rank||0)});
    if(!sorted.length)sorted=ASKILLS.slice(0,8);
    sorted.forEach(function(s){var sk=selCh.skills[s]||{rank:0,xp:0};var need=(sk.rank+1)*15;var pct=need>0?(sk.xp/need)*100:0;
      h+='<div style="padding:4px 0;border-bottom:1px solid var(--border)"><div style="display:flex;justify-content:space-between;font-size:12px"><span>'+s.replace(/_/g,' ')+'</span><span class="mono" style="font-size:10px">Rank '+sk.rank+' <span class="dim">('+sk.xp+'/'+need+' XP)</span></span></div><div class="xp-bar"><div class="xp-fill" style="width:'+pct+'%"></div></div></div>'});
  }else if(curTab==="base"){
    h+='<div style="font-weight:700;margin-bottom:8px">Camp ‚Äî Tier '+g.base.tier+' ‚Äî '+getAliveRoster().length+' survivors</div>';
    [{l:"Food",v:g.base.food+" days",c:"var(--accent-green)"},{l:"Water",v:g.base.water+" days",c:"var(--accent-blue)"},{l:"Medical",v:g.base.medical+" kits",c:"var(--accent-red)"},{l:"Defense",v:g.base.defense,c:"var(--accent-amber)"}].forEach(function(r){h+='<div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--border);font-size:13px"><span>'+r.l+'</span><span class="mono" style="color:'+r.c+'">'+r.v+'</span></div>'});
    h+='<div class="mono dim" style="font-size:10px;margin-top:10px;margin-bottom:6px;letter-spacing:2px">MATERIALS</div>';
    Object.keys(g.base.materials).forEach(function(m){h+='<div style="display:flex;justify-content:space-between;font-size:12px;padding:2px 0"><span>'+m+'</span><span class="mono">'+g.base.materials[m]+'</span></div>'});
    if(g.base.structures.length){h+='<div class="mono dim" style="font-size:10px;margin-top:10px;margin-bottom:6px;letter-spacing:2px">STRUCTURES</div>';g.base.structures.forEach(function(s){h+='<div style="font-size:12px;padding:2px 0;color:var(--accent-green)">‚úì '+s+'</div>'})}
    h+='<div class="mono dim" style="font-size:10px;margin-top:10px;margin-bottom:6px;letter-spacing:2px">BUILD</div>';
    RECIPES.forEach(function(r){var built=g.base.structures.indexOf(r.name)>=0;var canBuild=!built;var costStr=[];
      Object.keys(r.cost).forEach(function(m){var have=g.base.materials[m]||0;var need=r.cost[m];costStr.push(m+': '+have+'/'+need);if(have<need)canBuild=false});
      h+='<div style="padding:6px 0;border-bottom:1px solid var(--border)"><div style="display:flex;justify-content:space-between;font-size:12px"><span>'+(built?'‚úì ':'')+r.name+'</span>'+(built?'<span class="dim" style="font-size:10px">BUILT</span>':'<button class="debug-btn" style="background:'+(canBuild?'var(--accent-green)':'var(--text-dim)')+'" '+(canBuild?'onclick="buildStructure(\''+r.id+'\')"':'disabled')+'>BUILD</button>')+'</div><div class="dim" style="font-size:10px">'+r.desc+' ‚Äî Cost: '+costStr.join(', ')+'</div></div>'});
  }else if(curTab==="items"){
    var bg=BGS.find(function(b){return b.id===selCh.background});
    h+='<div style="font-weight:700;margin-bottom:8px">'+selCh.portrait+' '+selCh.name+' ‚Äî Inventory ('+selCh.inventory.length+')</div>';
    selCh.inventory.forEach(function(item){h+='<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border);font-size:12px"><span>'+item.name+'</span><span class="mono dim" style="font-size:10px">'+(item.uses?item.uses+'u ':'')+(item.damage||'')+(item.mat?' ['+item.mat+']':'')+' '+item.weight+'lb</span></div>'});
    if(!selCh.inventory.length)h+='<div class="dim" style="font-size:12px">Nothing but the clothes on their back.</div>';
  }else if(curTab==="zones"){
    h+='<div style="font-weight:700;margin-bottom:8px">Known Zones</div>';
    g.zones.filter(function(z){return z.status!=="unexplored"}).forEach(function(z){var cur=g.currentZone===z.id;h+='<div style="padding:4px 0;border-bottom:1px solid var(--border);font-size:12px">'+(cur?'üìç ':'')+z.name+' <span class="dim" style="font-size:10px">‚Äî '+z.label+(z.scarcity<30?' ‚ö† depleted':'')+'</span></div>'});
    var ux=g.zones.filter(function(z){return z.status==="unexplored"}).length;if(ux)h+='<div class="dim" style="font-size:10px;margin-top:6px">+ '+ux+' unexplored</div>';
  }else if(curTab==="rules"){
    h+='<div style="font-weight:700;margin-bottom:8px">'+g.theme+'</div>';var tc=g.themeConfig;
    if(tc){h+='<div style="font-size:11px;color:var(--accent-amber);font-style:italic;margin-bottom:8px">'+tc.tone+'</div><div class="mono dim" style="font-size:10px;letter-spacing:2px;margin-bottom:6px">RULES</div>';tc.rule.split('. ').forEach(function(r){if(r.trim())h+='<div style="font-size:11px;padding:3px 0;border-bottom:1px solid var(--border);color:var(--text-secondary)">‚Ä¢ '+r.trim()+'</div>'})}
  }else if(curTab==="log"){
    h+='<div style="font-weight:700;margin-bottom:8px">Day '+g.day+' ‚Äî '+g.timeOfDay+'</div><div class="dim" style="font-size:11px;margin-bottom:12px">Turns: '+g.turns+' | Threat: '+g.threat+'</div>';
    h+='<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:12px"><button class="debug-btn" style="background:var(--accent-blue)" onclick="undoLastTurn()">‚Ü© Undo Turn</button><button class="debug-btn" style="background:var(--accent-green)" onclick="exportSave()">üì§ Export</button></div>';
    var aiMod=LOCAL_MODELS.find(function(m){return m.id===S.localModel})||LOCAL_MODELS[0];
    h+='<div style="font-size:10px;color:var(--text-dim);font-family:monospace;margin-bottom:4px;letter-spacing:2px">'+aiMod.icon+' LOCAL AI</div>';
    if(aiStatus==='ready'){
      h+='<div style="padding:6px 10px;margin-bottom:4px;border-radius:4px;border:1px solid var(--accent-green);background:var(--bg-active);color:var(--accent-green);font-size:12px">'+aiMod.name+' ‚Äî Ready</div>';
    }else if(RESTRICTED_ORIGIN){
      h+='<div style="padding:6px 10px;margin-bottom:4px;border-radius:4px;border:1px solid var(--text-dim);background:var(--bg-active);color:var(--text-secondary);font-size:12px">Offline narrator active ‚Äî AI requires HTTPS origin</div>';
    }else{
      h+='<div style="padding:6px 10px;margin-bottom:4px;border-radius:4px;border:1px solid var(--accent-blue);background:var(--bg-active);color:var(--text-primary);font-size:12px">'+aiMod.name+' ‚Äî <span style="color:var(--text-dim)">Not loaded</span></div>';
      h+='<button style="display:block;width:100%;padding:6px 10px;margin-bottom:4px;border-radius:4px;border:1px solid var(--accent-blue);background:var(--bg-card);color:var(--accent-blue);font-size:12px;cursor:pointer;font-family:inherit" onclick="downloadModel()">‚¨á Download AI Model</button>';
    }
  }
  el.innerHTML=h;
}

// ============================================================
// PARTY MANAGEMENT
// ============================================================
function swapToBase(charId){
  var g=S.gs;
  if(g.activePartyIds.length<=1){showMsg("Can't send your last party member to base!");return}
  var ch=getRosterById(charId);if(!ch||ch.isLeader)return;
  ch.status="base";ch.zone="base";
  g.activePartyIds=g.activePartyIds.filter(function(id){return id!==charId});
  g.turnOrder=g.activePartyIds.slice();g.currentActorIndex=0;
  addNar("["+ch.name+" sent to base camp.]");
  renderSB();buildActs();autoSave();
}
function swapToParty(charId){
  var g=S.gs;
  if(g.activePartyIds.length>=4){showMsg("Active party is full (4/4).");return}
  if(g.currentZone!=='base'){showMsg("Must be at base to recruit party members.");return}
  var ch=getRosterById(charId);if(!ch)return;
  ch.status="active";ch.zone=g.currentZone;
  g.activePartyIds.push(charId);
  g.turnOrder=g.activePartyIds.slice();g.currentActorIndex=0;
  addNar("["+ch.name+" joined the active party.]");
  renderSB();buildActs();autoSave();
}

// ============================================================
// ACTIONS
// ============================================================
function buildActs(){
  var g=S.gs,dd=DIFFS.find(function(d){return d.id===g.diff})||DIFFS[1];
  var actor=getCurrentActor();
  var acts=[
    {id:"scout",label:"üî≠ Scout",skill:"spot",dc:10+Math.floor(g.day/7)},
    {id:"scavenge",label:"üîç Scavenge",skill:"search",dc:12},
    {id:"fortify",label:"üî® Fortify",skill:"craft_struct",dc:10+g.base.defense},
    {id:"travel",label:"üö∂ Travel",skill:null,dc:null},
    {id:"rest",label:"üí§ Rest",skill:null,dc:null}
  ];
  // Actor indicator
  var party=getActiveParty();
  var actorIdx=g.activePartyIds.indexOf(actor.id)+1;
  var label=actor.portrait+' <strong>'+actor.name+'</strong>';
  if(party.length>1)label+=' <span class="dim" style="font-size:10px">('+actorIdx+'/'+party.length+')</span>';
  $('act-label').innerHTML=label;
  var h='';acts.forEach(function(a){var dc=a.dc?a.dc+dd.dcMod:null;h+='<button class="action-btn" data-act=\''+JSON.stringify(a).replace(/'/g,"&#39;")+'\'><span style="font-weight:500">'+a.label+'</span>'+(dc?' <span class="mono dim" style="font-size:10px">DC '+dc+'</span>':'')+'</button>'});
  $('act-btns').innerHTML=h;$('act-btns').style.gridTemplateColumns='1fr 1fr';
  document.querySelectorAll('.action-btn').forEach(function(b){b.addEventListener('click',function(){doAct(JSON.parse(b.getAttribute('data-act')))})});
}

function addNar(text){var el=$('narrative-scroll'),div=document.createElement('div');div.style.cssText='margin-bottom:20px;font-family:Georgia,serif;line-height:1.8;font-size:15px;animation:fadeIn .4s ease-out';text.split('\n').filter(function(p){return p.trim()}).forEach(function(p){var pa=document.createElement('p');pa.style.marginBottom='12px';pa.textContent=p;div.appendChild(pa)});el.appendChild(div);el.scrollTop=el.scrollHeight}
function addRoll(action,roll,dc,success){var el=$('narrative-scroll'),div=document.createElement('div');div.style.cssText='margin-bottom:12px;padding:8px 12px;background:var(--bg-card);border-radius:6px;border-left:3px solid var(--accent-amber);animation:diceAnim .5s ease-out';div.innerHTML='<div class="mono" style="font-size:11px;color:var(--accent-amber);margin-bottom:4px">ACTION: '+action+'</div><div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap"><span class="mono" style="font-size:20px;font-weight:700;color:'+(roll.nat===20?'var(--accent-amber)':roll.nat===1?'var(--accent-red)':'var(--text-primary)')+'">üé≤ '+roll.nat+'</span><span class="dim" style="font-size:12px">+'+roll.mod+' = '+roll.total+'</span><span class="dim" style="font-size:12px">vs DC '+dc+'</span><span style="padding:2px 8px;border-radius:3px;font-size:11px;font-weight:700;background:'+(success?'rgba(74,122,58,.2)':'rgba(166,61,47,.2)')+';color:'+(success?'var(--accent-green)':'var(--accent-red)')+'">'+(success?'SUCCESS':'FAILED')+'</span></div>';el.appendChild(div);el.scrollTop=el.scrollHeight}
function setLoad(on){$('loading').style.display=on?'block':'none';$('action-panel').style.display=on?'none':'block'}

// Skill XP helper ‚Äî ch parameter optional, defaults to current actor
function awardXP(skillId,success,ch){
  ch=ch||getCurrentActor();if(!ch)return 0;
  if(!ch.skills[skillId])ch.skills[skillId]={rank:0,xp:0};
  var sk=ch.skills[skillId];sk.xp+=success?3:1;
  var need=(sk.rank+1)*15;
  if(sk.xp>=need&&sk.rank<15){sk.rank++;sk.xp=sk.xp-need;return sk.rank}
  return 0;
}

// ============================================================
// TRAVEL SYSTEM
// ============================================================
function showTravelUI(){
  var g=S.gs,h='<div class="travel-panel"><div style="font-weight:700;margin-bottom:8px">üö∂ TRAVEL ‚Äî Choose Destination</div>';
  var scouted=g.zones.filter(function(z){return z.status==='scouted'});
  if(!scouted.length){addNar("[No scouted zones. Scout first.]");return}
  scouted.forEach(function(z){var isCur=g.currentZone===z.id;
    var dots='';for(var i=1;i<=5;i++)dots+='<span style="display:inline-block;width:5px;height:5px;border-radius:1px;background:'+(i<=z.danger?'var(--accent-red)':'var(--bg-hover)')+';margin-left:2px"></span>';
    h+='<div class="zone-pick'+(isCur?' sel':'')+'" onclick="doTravel(\''+z.id+'\')"><div style="display:flex;justify-content:space-between;align-items:center"><div><strong>'+z.name+'</strong>'+(isCur?' <span class="dim">(here)</span>':'')+'<div class="dim" style="font-size:10px">'+z.label+' ‚Äî '+(z.scarcity>60?'Good loot':z.scarcity>30?'Picked over':'Nearly depleted')+'</div></div><div>'+dots+'</div></div></div>'});
  h+='<button class="btn-ghost btn-sm" onclick="closeTravelUI()" style="margin-top:8px">CANCEL</button></div>';
  var el=$('narrative-scroll'),div=document.createElement('div');div.id='travel-ui';div.innerHTML=h;el.appendChild(div);el.scrollTop=el.scrollHeight;
}
function closeTravelUI(){var el=$('travel-ui');if(el)el.remove()}

async function doTravel(zoneId){
  closeTravelUI();
  var g=S.gs,zone=g.zones.find(function(z){return z.id===zoneId});if(!zone)return;
  if(g.currentZone===zoneId){addNar("[You're already here. Look around.]");return}
  setLoad(true);$('loading-text').textContent='Traveling to '+zone.name+'...';

  // Travel risk roll
  var nightMod=g.timeOfDay==='night'?3:g.timeOfDay==='dusk'?1:0;
  var risk=zone.danger+g.threat+nightMod;
  var travelRoll=rollD20();
  var safe=travelRoll>risk;

  // Pick travel event
  var totalWeight=TRAVEL_EVENTS.reduce(function(s,e){return s+e.weight},0);
  var roll=Math.random()*totalWeight,acc=0,event=TRAVEL_EVENTS[TRAVEL_EVENTS.length-1];
  for(var i=0;i<TRAVEL_EVENTS.length;i++){acc+=TRAVEL_EVENTS[i].weight;if(roll<=acc){event=TRAVEL_EVENTS[i];break}}

  // Override to ambush if roll failed
  if(!safe)event=TRAVEL_EVENTS[0];

  g.currentZone=zoneId;
  // Advance time
  var times=["dawn","morning","afternoon","dusk","night"];var idx=times.indexOf(g.timeOfDay);
  if(idx<times.length-1)g.timeOfDay=times[idx+1];

  var ctx="Traveled to "+zone.name+" ("+zone.label+"). Travel roll: "+travelRoll+" vs risk "+risk+". "+event.desc;

  if(event.combat){
    var txt=await callAI(ctx+" An ambush!");addNar(txt);
    setLoad(false);
    startCombat(zone.danger);
  }else if(event.loot){
    var loot=gLoot();var actor=getCurrentActor();loot.forEach(function(i){actor.inventory.push(i)});
    ctx+=" Found: "+loot.map(function(i){return i.name}).join(", ")+".";
    var txt=await callAI(ctx);addNar(txt);setLoad(false);
  }else{
    var txt=await callAI(ctx);addNar(txt);setLoad(false);
  }
  g.turns++;updateHUD();renderSB();buildActs();autoSave();
}

// ============================================================
// COMBAT SYSTEM
// ============================================================
function generateEnemies(dangerLevel){
  var count=1+Math.floor(Math.random()*(dangerLevel>3?3:2));
  var pool=ENEMIES.filter(function(e){return e.spd<=dangerLevel*2});
  if(!pool.length)pool=ENEMIES.slice(0,3);
  var enemies=[];
  for(var i=0;i<count;i++){var template=pick(pool);var bonusHP=Math.floor(Math.random()*dangerLevel);enemies.push({id:"e"+i,name:template.name+(count>1?' '+(i+1):''),hp:template.hp+bonusHP,maxHP:template.hp+bonusHP,atk:template.atk,def:template.def,behavior:template.behavior,xp:template.xp})}
  return enemies;
}

function startCombat(dangerLevel){
  inCombat=true;
  var enemies=generateEnemies(dangerLevel||2);
  combatState={enemies:enemies,log:[],round:1};
  $('combat-overlay').style.display='flex';
  renderCombat();
}

function renderCombat(){
  var cs=combatState,ch=getLeader();
  // Enemies
  var h='';cs.enemies.forEach(function(e){
    var pct=(e.hp/e.maxHP)*100;
    h+='<div class="enemy-card" id="enemy-'+e.id+'"><div style="display:flex;justify-content:space-between;align-items:center"><strong>'+e.name+'</strong><span class="mono" style="font-size:11px;color:'+(pct>50?'var(--accent-green)':pct>25?'var(--accent-amber)':'var(--accent-red)')+'">'+e.hp+'/'+e.maxHP+' HP</span></div><div class="bar-track" style="margin-top:4px"><div class="bar-fill" style="width:'+pct+'%;background:'+(pct>50?'var(--accent-green)':pct>25?'var(--accent-amber)':'var(--accent-red)')+'"></div></div></div>'});
  $('combat-enemies').innerHTML=h;
  // Log
  h='';cs.log.slice(-6).forEach(function(l){h+='<div class="combat-log-entry '+l.type+'">'+l.text+'</div>'});
  $('combat-log').innerHTML=h;$('combat-log').scrollTop=$('combat-log').scrollHeight;
  // Actions
  var alive=cs.enemies.filter(function(e){return e.hp>0});
  if(!alive.length){
    $('combat-actions').innerHTML='<button class="btn" style="grid-column:1/-1" onclick="endCombat(true)">üèÜ VICTORY ‚Äî Continue</button>';return;
  }
  if(ch.hp<=0){
    $('combat-actions').innerHTML='<button class="btn" style="grid-column:1/-1;background:var(--accent-red)" onclick="endCombat(false)">üíÄ DEFEATED</button>';return;
  }
  $('combat-actions').innerHTML='<button class="action-btn" onclick="combatAction(\'attack\')">‚öîÔ∏è Attack</button><button class="action-btn" onclick="combatAction(\'defend\')">üõ°Ô∏è Defend</button><button class="action-btn" onclick="combatAction(\'flee\')">üèÉ Flee</button><button class="action-btn" onclick="combatAction(\'item\')">üíä Use Item</button>';
}

function combatAction(type){
  var cs=combatState,g=S.gs,ch=getLeader(),dd=DIFFS.find(function(d){return d.id===g.diff})||DIFFS[1];
  var alive=cs.enemies.filter(function(e){return e.hp>0});if(!alive.length)return;
  var target=alive[0]; // target first alive enemy

  if(type==='attack'){
    var nat=rollD20(),mod=getMod(ch.attrs.fitness)+(ch.skills.melee?ch.skills.melee.rank:0),tot=nat+mod;
    var hit=tot>=(10+target.def+dd.dcMod);
    var dmg=0;
    if(hit||nat===20){
      var weapon=ch.inventory.find(function(i){return i.type==='weapon'&&i.damage});
      dmg=weapon?rollDice(weapon.damage):rollDice("1d4");
      if(nat===20)dmg*=2;
      dmg=Math.max(1,dmg);target.hp=Math.max(0,target.hp-dmg);
      cs.log.push({type:nat===20?'crit':'hit',text:'üé≤ '+nat+'+'+mod+'='+tot+(nat===20?' CRIT!':'')+' ‚Üí Hit '+target.name+' for '+dmg+' dmg!'+(target.hp<=0?' üíÄ KILLED':'')});
      var eCard=$('enemy-'+target.id);if(eCard)eCard.classList.add('shake');setTimeout(function(){if(eCard)eCard.classList.remove('shake')},300);
    }else{
      cs.log.push({type:'miss',text:'üé≤ '+nat+'+'+mod+'='+tot+' ‚Üí Missed '+target.name});
    }
    awardXP('melee',hit);
  }else if(type==='defend'){
    ch.stamina=Math.min(ch.maxStamina,ch.stamina+1);
    cs.log.push({type:'miss',text:'üõ°Ô∏è You brace yourself. +1 stamina recovered.'});
    // Enemies get reduced damage this round
    alive.forEach(function(e){if(e.hp>0){var eRoll=rollD20()+e.atk;var dodge=10+getMod(ch.attrs.agility)+(ch.skills.evasion?ch.skills.evasion.rank:0);if(eRoll>=dodge){var eDmg=Math.max(0,Math.floor(e.atk/2)-1);ch.hp=Math.max(0,ch.hp-eDmg);if(eDmg>0)cs.log.push({type:'hit',text:e.name+' attacks for '+eDmg+' (blocked)'})}else{cs.log.push({type:'miss',text:e.name+' attacks ‚Äî you deflect it!'})}}});
    cs.round++;renderCombat();return;
  }else if(type==='flee'){
    var fleeRoll=rollD20()+getMod(ch.attrs.agility);
    if(fleeRoll>=12+dd.dcMod){
      cs.log.push({type:'miss',text:'üèÉ Rolled '+fleeRoll+' ‚Äî You escape!'});
      awardXP('evasion',true);
      setTimeout(function(){endCombat(null)},500);renderCombat();return;
    }else{
      cs.log.push({type:'hit',text:'üèÉ Rolled '+fleeRoll+' ‚Äî Blocked! They swarm you.'});
      awardXP('evasion',false);
    }
  }else if(type==='item'){
    var med=ch.inventory.find(function(i){return i.type==='medical'&&i.uses>0});
    if(med){med.uses--;var heal=rollDice("1d6")+2;ch.hp=Math.min(ch.maxHP,ch.hp+heal);
      cs.log.push({type:'crit',text:'üíä Used '+med.name+'. Healed '+heal+' HP.'});
      if(med.uses<=0)ch.inventory=ch.inventory.filter(function(i){return i!==med});
    }else{cs.log.push({type:'miss',text:'No medical supplies!'});renderCombat();return}
  }

  // Enemy turn (skip if defending, already handled)
  if(type!=='defend'){
    alive=cs.enemies.filter(function(e){return e.hp>0});
    alive.forEach(function(e){
      var eRoll=rollD20()+e.atk;var dodge=10+getMod(ch.attrs.agility)+(ch.skills.evasion?ch.skills.evasion.rank:0);
      if(eRoll>=dodge){var eDmg=Math.max(1,e.atk+Math.floor(Math.random()*3));ch.hp=Math.max(0,ch.hp-eDmg);cs.log.push({type:'hit',text:e.name+' hits you for '+eDmg+'! (HP: '+ch.hp+')'})}
      else{cs.log.push({type:'miss',text:e.name+' swings and misses!'})}
    });
  }
  cs.round++;renderCombat();
}

function endCombat(won){
  $('combat-overlay').style.display='none';inCombat=false;
  var g=S.gs,ch=getLeader();
  if(won===true){
    var totalXP=combatState.enemies.reduce(function(s,e){return s+e.xp},0);
    ch.morale=Math.min(100,ch.morale+5);
    addNar("[COMBAT VICTORY ‚Äî "+combatState.enemies.length+" enemies defeated. +"+totalXP+" combat XP. +5 morale.]");
  }else if(won===false){
    ch.morale=Math.max(0,ch.morale-15);
    addNar("[DEFEATED ‚Äî You barely escaped with your life. -15 morale.]");
    if(ch.hp<=0){ch.hp=1;addNar("[You cling to life. 1 HP remaining.]")}
  }else{
    ch.morale=Math.max(0,ch.morale-3);
    addNar("[FLED COMBAT ‚Äî You escaped, but the threat remains. -3 morale.]");
  }
  combatState=null;updateHUD();renderSB();autoSave();
}

// ============================================================
// BASE BUILDING
// ============================================================
function buildStructure(recipeId){
  var g=S.gs,r=RECIPES.find(function(x){return x.id===recipeId});if(!r)return;
  if(g.base.structures.indexOf(r.name)>=0)return;
  // Check costs
  var canBuild=true;
  Object.keys(r.cost).forEach(function(m){if((g.base.materials[m]||0)<r.cost[m])canBuild=false});
  if(!canBuild){addNar("[Not enough materials for "+r.name+".]");return}
  // Deduct
  Object.keys(r.cost).forEach(function(m){g.base.materials[m]-=r.cost[m]});
  g.base.structures.push(r.name);
  // Apply effects
  if(r.effect.defense)g.base.defense+=r.effect.defense;
  if(r.effect.waterPerDay)g.base.waterPerDay+=r.effect.waterPerDay;
  if(r.effect.foodCap)g.base.foodCap+=r.effect.foodCap;
  if(r.effect.restHeal)g.base.restHeal+=r.effect.restHeal;
  addNar("[BUILT: "+r.name+" ‚Äî "+r.desc+"]");
  renderSB();autoSave();
}

// Daily tick ‚Äî affects all alive survivors
function dailyTick(g){
  var alive=g.roster.filter(function(c){return c.status!=="dead"&&c.status!=="missing"});
  var pop=alive.length;
  g.base.pop=pop;
  g.base.food=Math.max(0,g.base.food-pop);
  g.base.water=Math.max(0,g.base.water-pop);
  g.base.water+=g.base.waterPerDay; // rain collector
  // Starvation/dehydration affects everyone
  alive.forEach(function(ch){
    if(g.base.food<=0){ch.hp=Math.max(0,ch.hp-2);ch.morale=Math.max(0,ch.morale-5)}
    if(g.base.water<=0){ch.stamina=Math.max(0,ch.stamina-2);ch.morale=Math.max(0,ch.morale-5)}
  });
  // Threat escalation ‚Äî more people = more attention
  g.threat+=Math.max(1,Math.floor(pop/3));
}

// ============================================================
// AI NARRATION (Local via Wllama)
// ============================================================
function buildSummary(){
  var g=S.gs;
  var active=getActiveParty();
  var lines=["Day "+g.day+", "+g.timeOfDay+", "+g.weather, g.theme];
  lines.push("Active party at "+g.currentZone+":");
  active.forEach(function(ch){
    lines.push("  "+ch.name+" ("+ch.background+") HP:"+ch.hp+"/"+ch.maxHP+" Morale:"+ch.morale);
  });
  var base=getBaseRoster();
  if(base.length){
    lines.push("At base ("+base.length+" survivors):");
    base.forEach(function(ch){lines.push("  "+ch.name+" ‚Äî "+(g.base.assignments[ch.id]||"idle"))});
  }
  lines.push("Base: Food:"+g.base.food+" Water:"+g.base.water+" Def:"+g.base.defense);
  lines.push("Threat:"+g.threat);
  if(g.memory.length)lines.push("Recent: "+g.memory.slice(-3).join("; "));
  return lines.join("\n");
}

// ============================================================
// LOCAL AI ENGINE (Wllama - llama.cpp in WebAssembly)
// Requires HTTPS origin for ES modules, IndexedDB, and WASM.
// Falls back to offline narrator on restricted origins.
// ============================================================
var WLLAMA_VER='2.3.7';
var WLLAMA_CDN='https://cdn.jsdelivr.net/npm/@wllama/wllama@'+WLLAMA_VER+'/esm/';
var WASM_PATHS={
  'single-thread/wllama.js':WLLAMA_CDN+'single-thread/wllama.js',
  'single-thread/wllama.wasm':WLLAMA_CDN+'single-thread/wllama.wasm',
  'multi-thread/wllama.js':WLLAMA_CDN+'multi-thread/wllama.js',
  'multi-thread/wllama.wasm':WLLAMA_CDN+'multi-thread/wllama.wasm',
  'multi-thread/wllama.worker.mjs':WLLAMA_CDN+'multi-thread/wllama.worker.mjs'
};

// Strip ESM syntax from a module ‚Äî all files share one scope so
// import/export becomes unnecessary (deps are already in scope)
function stripESM(code){
  // Remove all import lines (deps already in shared scope)
  code=code.replace(/^\s*import\s+\{[^}]*\}\s*from\s*["'][^"']*["']\s*;?\s*$/gm,'');
  code=code.replace(/^\s*import\s+\w+\s+from\s*["'][^"']*["']\s*;?\s*$/gm,'');
  code=code.replace(/^\s*import\s+\*\s+as\s+\w+\s+from\s*["'][^"']*["']\s*;?\s*$/gm,'');
  code=code.replace(/^\s*import\s*["'][^"']*["']\s*;?\s*$/gm,'');
  // Remove re-export lines: export { X } from './file.js' (value already in scope)
  code=code.replace(/^\s*export\s*\{[^}]*\}\s*from\s*["'][^"']*["']\s*;?\s*$/gm,'');
  // Remove standalone export { X } (value already in scope)
  code=code.replace(/^\s*export\s*\{[^}]*\}\s*;?\s*$/gm,'');
  // Strip export keyword from declarations
  code=code.replace(/export\s+default\s+(class|function)\s/g,'$1 ');
  code=code.replace(/export\s+default\s+/g,'var __wllama_default=');
  code=code.replace(/export\s+(class|function|const|let|var|async\s+function)\s/g,'$1 ');
  // Replace import.meta.url with CDN base
  code=code.replace(/import\.meta\.url/g,'"'+WLLAMA_CDN+'"');
  return code;
}

// Discover local ./relative imports from source
function discoverLocalImports(code){
  var deps=[],re=/(?:import|export)\s+[\s\S]*?from\s*["'](\.\/[^"']+)["']/g,m;
  while((m=re.exec(code))!==null){
    var f=m[1].replace(/^\.\//,'');
    if(deps.indexOf(f)<0)deps.push(f);
  }
  return deps;
}

async function initWllama(){
  if(wllamaEngine)return wllamaEngine;
  dbgLog('Loading Wllama engine...');
  var Wllama=null;

  // Strategy 1: direct ES module import (works from https:// origins)
  try{
    dbgLog('Trying direct import...');
    var mod=await import('https://esm.sh/@wllama/wllama@'+WLLAMA_VER);
    Wllama=mod.Wllama;
    dbgLog('Direct import succeeded');
  }catch(e){dbgLog('Direct import failed: '+e.message)}

  // Strategy 2: runtime fetch+bundle (works from content:// and file://)
  // Fetches raw source files, strips ESM syntax, runs as classic script
  if(!Wllama){
    try{
      dbgLog('Trying runtime fetch+bundle from jsDelivr...');
      var base=WLLAMA_CDN;
      var fetched={};
      var order=[];

      // Recursively fetch a module and its local dependencies
      async function fetchMod(filename){
        if(fetched[filename])return;
        fetched[filename]='';// mark as visited to prevent cycles
        var resp=await fetch(base+filename);
        if(!resp.ok)throw new Error('HTTP '+resp.status+' for '+filename);
        var code=await resp.text();
        fetched[filename]=code;
        // Fetch dependencies first (topological ordering)
        var deps=discoverLocalImports(code);
        for(var i=0;i<deps.length;i++)await fetchMod(deps[i]);
        // Add self after all deps loaded
        order.push(filename);
      }

      await fetchMod('index.js');
      dbgLog('Fetched '+order.length+' modules: '+order.join(', '));

      // Build single script: all files in one scope, deps first
      var allCode='';
      for(var i=0;i<order.length;i++){
        allCode+='\n/* --- '+order[i]+' --- */\n'+stripESM(fetched[order[i]]);
      }
      // Wrap in IIFE and expose Wllama globally
      allCode='(function(){\n'+allCode+'\nif(typeof Wllama!=="undefined")window._WllamaRT=Wllama;\n})();';

      // Execute as classic script (no CORS restrictions!)
      var script=document.createElement('script');
      script.textContent=allCode;
      document.head.appendChild(script);

      if(window._WllamaRT){
        Wllama=window._WllamaRT;
        dbgLog('Runtime fetch+bundle succeeded!');
      }else{
        dbgLog('Wllama class not found after bundle execution');
      }
    }catch(e){dbgLog('Runtime fetch+bundle failed: '+e.message)}
  }

  if(!Wllama)throw new Error('Could not load AI engine. Try opening via web server or install as PWA.');
  wllamaEngine=new Wllama(WASM_PATHS);
  dbgLog('Wllama engine ready');
  return wllamaEngine;
}

async function downloadModel(){
  var m=LOCAL_MODELS.find(function(x){return x.id===S.localModel});
  if(!m){showMsg('No model selected');return}
  if(RESTRICTED_ORIGIN){
    showMsg('AI download requires HTTPS. Host on GitHub Pages or use a local web server, then try again. Offline narrator works great in the meantime!');
    dbgLog('Download blocked: restricted origin ('+location.protocol+')');
    return;
  }
  aiStatus='downloading';aiProgress=0;updateAIStatus();
  try{
    var engine=await initWllama();
    dbgLog('Downloading '+m.name+' from HuggingFace...');
    await engine.loadModelFromHF(m.hfRepo,m.hfFile,{
      progressCallback:function(p){
        if(p.total>0)aiProgress=Math.round((p.loaded/p.total)*100);
        updateAIStatus();
      },
      n_ctx:IS_MOBILE?1024:2048,
      n_threads:IS_MOBILE?1:2
    });
    aiStatus='ready';aiModelId=S.localModel;
    updateAIStatus();
    saveSettings();
    showMsg(m.name+' loaded! AI narrator active.');
    dbgLog('Model loaded: '+m.name);
  }catch(e){
    aiStatus='error';updateAIStatus();
    dbgLog('Download error: '+e.message);
    showMsg('Download failed. Try from HTTPS (GitHub Pages) or skip to use offline narrator.');
  }
}

async function callLocalAI(sys,user){
  if(!wllamaEngine||aiStatus!=='ready')throw new Error('Model not loaded');
  // Race against timeout ‚Äî mobile WASM can hang on large models
  var AI_TIMEOUT=45000; // 45 seconds
  try{
    var result=await Promise.race([
      wllamaEngine.createChatCompletion(
        [{role:"system",content:sys},{role:"user",content:user}],
        {nPredict:120,sampling:{temp:0.8,top_k:40,top_p:0.9,min_p:0.05}}
      ),
      new Promise(function(_,reject){setTimeout(function(){reject(new Error('AI_TIMEOUT'))},AI_TIMEOUT)})
    ]);
    return result||'';
  }catch(e){
    if(e.message==='AI_TIMEOUT'){
      dbgLog('AI timed out after '+AI_TIMEOUT/1000+'s ‚Äî falling back to offline narrator');
      // Disable AI to avoid repeated timeouts
      aiStatus='error';
      showMsg('AI too slow on this device. Switched to offline narrator. Try the 360M model for faster results.');
    }else{dbgLog('Local AI error: '+e.message)}
    throw e;
  }
}

async function callAI(ctx){
  var tc=S.gs.themeConfig||{};
  var sysPrompt="You are a tabletop RPG dungeon master running a zombie survival game. Be CONCISE.\nTHEME: "+S.gs.theme+"\nTONE: "+(tc.tone||"Grim survival horror")+"\nWORLD RULES:\n"+(tc.rule||"Standard zombies")+"\n\nSTYLE:\n- Write like a DM talking to a player, NOT a novelist\n- MAX 2 short paragraphs. 2-4 sentences each.\n- Second person, present tense.\n- One sensory detail per paragraph.\n- End with what the player sees/hears NOW\n- NEVER resolve what the player hasn't decided\n- Apply WORLD RULES faithfully.";
  var userMsg=buildSummary()+"\n\nCONTEXT: "+ctx+"\n\nNarrate briefly.";
  try{
    var txt='';
    if(aiStatus==='ready')txt=await callLocalAI(sysPrompt,userMsg);
    else txt=fallback(ctx);
    // Sanitize: strip any JSON dumps, cap length
    if(txt.length>1200)txt=txt.substring(0,1200)+'...';
    txt=txt.replace(/```[\s\S]*?```/g,'').replace(/\{[\s\S]{50,}\}/g,'').trim();
    // Update memory
    var summary=txt.substring(0,80).replace(/\n/g,' ');
    S.gs.memory.push(summary);if(S.gs.memory.length>5)S.gs.memory.shift();
    return txt||fallback(ctx);
  }catch(e){console.error('AI call failed:',e);dbgLog('AI Error: '+e.message);return fallback(ctx)}
}

var offlineWarned=false;
function fallback(ctx){
  var g=S.gs;if(!g)return "The world waits...";
  var ch=getLeader()||g.roster[0],tc=g.themeConfig||{},cfg=tc.config||{};
  var nm=ch.name,loc=g.locName||"the ruins",day=g.day,tod=g.timeOfDay,thr=g.threat;
  var zone=g.zones.find(function(z){return z.id===g.currentZone})||{name:"camp",label:"Base",danger:1};

  // Rich vocabulary pools keyed on theme/state
  var originSmell={Virus:"rot and iron",Fungus:"damp spores and sweet decay",Chemical:"acrid chemicals",Parasite:"something faintly wrong in the air",Radiation:"metallic ozone",Supernatural:"cold that shouldn't be there",Alien:"a hum you feel in your teeth",Prion:"the sour tang of fever"};
  var smell=originSmell[cfg.origin]||"decay and dust";
  var todAtmo={dawn:"Pale light bleeds through the haze. The world holds its breath between darkness and whatever comes next.",morning:"Thin morning light. Shadows pull back from doorways like retreating fingers. You can almost pretend it's normal.",afternoon:"The sun is high but it doesn't feel warm anymore. Everything looks too sharp, too exposed.",dusk:"The light is going amber, then copper. You have minutes before the dark makes everything worse.",night:"Darkness. Total and heavy. Your ears become your eyes. Every creak, every scrape ‚Äî a decision."};
  var timeText=todAtmo[tod]||todAtmo.morning;

  // Health-aware flavor
  var healthText="";
  if(ch.hp<=ch.maxHP*0.25)healthText="Every breath is a knife. "+nm+"'s vision swims at the edges. This can't go on much longer.";
  else if(ch.hp<=ch.maxHP*0.5)healthText="The wounds are slowing "+nm+" down. Each step costs something.";
  else if(ch.stamina<=2)healthText="Exhaustion pulls at "+nm+"'s limbs like gravity doubled overnight.";

  // Resource warnings
  var resText="";
  if(g.base.food<=1&&g.base.water<=1)resText="The camp is running on fumes. No food. No water. Decisions are about to get ugly.";
  else if(g.base.food<=1)resText="The last can sits on the shelf like a dare. Food's gone after this.";
  else if(g.base.water<=1)resText="Water's almost out. Throats crack when people talk.";
  else if(g.base.food<=3)resText="Supplies are thin. Everyone's counting cans.";

  // Threat atmosphere
  var threatText="";
  if(thr>=8)threatText="The dead are everywhere now. Hordes press against the edges of "+loc+" like a tide. Every sound draws more.";
  else if(thr>=5)threatText="Activity is increasing. You hear them at night ‚Äî shuffling, scraping. They know you're here.";
  else if(thr>=3)threatText="Signs of movement in the adjacent streets. Not close. Not yet.";

  // Theme-specific flavor
  var themeLines={
    "The Walking Dead":["Everyone carries it. Every death is a race to the brain.","The living are worse than the dead. Always have been.","A walker stumbles past, jaw hanging. It used to be someone's neighbor."],
    "28 Days Later":["Silence is survival. One scream and the sprinters come.","They're not dead. They're faster than you. And they never stop.","Blood on a wall. Still wet. Whoever was here didn't make it."],
    "The Last of Us":["Clickers in the dark. That awful wet clicking echoing off concrete.","Spore clouds hang in the lower floors like poison fog.","A runner sprints through a doorway two blocks away. Then silence."],
    "Resident Evil":["Something mutated was here. The claw marks go three inches into the steel door.","Umbrella left supplies ‚Äî sealed, branded, suspicious.","A security camera blinks red. Someone is still watching."],
    "Dying Light":["The UV flashlight flickers. Volatiles don't come out in light. Usually.","Parkour saved your life today. The rooftops are the only safe road.","Night falls. The rules change. Everything gets faster, hungrier, smarter."],
    "Dead Space":["The Marker hum is louder today. You can feel it behind your eyes.","Headshots don't work. You aim for the limbs. Always the limbs.","Something skitters in the vents above. The sound of too many joints."]
  };
  var themeFlavor="";
  if(themeLines[g.theme]){themeFlavor=pick(themeLines[g.theme])}
  else{
    var genericTheme=["The world ended. "+nm+" didn't.","Another day in the aftermath. Another day choosing between bad and worse.","The old rules are gone. The new ones are simple: don't die.","Somewhere in "+loc+", something is still moving. Could be survivors. Could be worse.","Day "+day+". "+nm+" marks it on the wall. Keeping count matters. It's the last normal thing left."];
    themeFlavor=pick(genericTheme);
  }

  // Context-specific narration (action results)
  var actText="";
  if(ctx){
    var suc=ctx.indexOf('SUCCESS')>=0,fail=ctx.indexOf('FAILURE')>=0;
    if(ctx.indexOf('OPENING')>=0){
      actText=nm+" sets down the last bag and surveys the camp near "+loc+". "+timeText+"\n\n"+(themeFlavor||"The apocalypse is here. It doesn't care if you're ready.")+"\n\n"+(cfg.origin?"The "+cfg.origin.toLowerCase()+" changed everything. "+(tc.rule?tc.rule.split('.').slice(0,2).join('.')+'.':''):'The world broke, and it\'s not getting fixed.')+" Day one. Survival starts now.";
      return showOfflineTag(actText);
    }
    if(ctx.indexOf('Scout')>=0||ctx.indexOf('scout')>=0){
      if(suc){
        var revealed=ctx.match(/Revealed: (.+?)\./);
        actText=nm+" climbs to higher ground, scanning the wreckage of "+loc+" through cracked binoculars."+(revealed?" Through the haze: "+revealed[1]+". Possible supply runs, possible death traps.":"")+"\n\nThe city gives up its secrets slowly. Every revealed zone is a door that might open ‚Äî or might bite.";
      }else{
        actText="Visibility is garbage. "+nm+" squints through dust and smoke, trying to read the skeleton of "+loc+". Nothing useful. The city keeps its secrets today.\n\nWasted time. Wasted energy. The dead don't care about your plans.";
      }
    }else if(ctx.indexOf('Scavenge')>=0||ctx.indexOf('scavenge')>=0||ctx.indexOf('search')>=0){
      if(suc){
        var found=ctx.match(/Found: (.+?)\./);
        actText=nm+" moves through "+zone.name+" with practiced care ‚Äî checking shelves, prying open cabinets, listening for movement between each step."+(found?"\n\nPayoff: "+found[1]+". Not much, but out here, 'not much' keeps you alive another day.":"\n\nSomething useful turns up in the wreckage. Not much, but enough.");
        if(ctx.indexOf('not alone')>=0)actText+="\n\nThen ‚Äî a sound. Wrong sound. Close.";
      }else{
        var failScav=["The shelves are bare. Someone got here first ‚Äî or something scared them off before they could finish.","Nothing. Broken glass and empty packaging. "+nm+" kicks a can across the floor and immediately regrets the noise.","Every drawer, every cabinet. Empty. "+zone.name+" has been picked clean. The "+loc+" area is drying up."];
        actText=pick(failScav)+"\n\n-1 stamina. The effort cost more than it returned.";
      }
    }else if(ctx.indexOf('Fortif')>=0||ctx.indexOf('fortif')>=0){
      if(suc){actText=nm+" works with whatever's at hand ‚Äî boards across windows, furniture stacked against doors, wire strung at ankle height. It's not pretty. It doesn't need to be.\n\nThe camp's defenses improve. Defense rating: "+g.base.defense+". Every point is a second of warning when they come."}
      else{actText="The barricade holds for about three seconds before collapsing. Wrong angle, wrong materials, wrong everything. "+nm+" wipes sweat and starts over.\n\nThe camp stays as vulnerable as before. Try again tomorrow."}
    }else if(ctx.indexOf('Rest')>=0||ctx.indexOf('rest')>=0){
      if(tod==='night'){actText=nm+" pulls a blanket tighter and tries to sleep. The sounds never stop ‚Äî groaning timber, distant shrieks, wind that might not be wind.\n\nSleep comes in fragments. "+nm+" wakes feeling slightly better. Slightly."+(ctx.indexOf('stirs in the dark')>=0?"\n\nThen the barricade rattles.":"")}
      else{actText=nm+" sits against the wall and closes their eyes. Just for a minute. The sun is still up ‚Äî that's something.\n\nBreathing slows. Muscles unclench. +2 stamina recovered. The world will still be ending when "+nm+" opens their eyes."}
    }else if(ctx.indexOf('Travel')>=0||ctx.indexOf('Traveled')>=0){
      var dest=ctx.match(/Traveled to (.+?) \(/);var destName=dest?dest[1]:zone.name;
      if(ctx.indexOf('ambush')>=0||ctx.indexOf('Ambush')>=0){actText="The route to "+destName+" looked clear. It wasn't.\n\n"+nm+" rounds a corner and they're RIGHT THERE ‚Äî bloated silhouettes lurching from a doorway. No time to think."}
      else if(ctx.indexOf('cache')>=0||ctx.indexOf('stash')>=0){
        var stashFound=ctx.match(/Found: (.+?)\./);
        actText="The road to "+destName+" winds through collapsed storefronts and overturned cars. Halfway there, "+nm+" spots something ‚Äî an overturned SUV with the trunk still sealed."+(stashFound?"\n\nInside: "+stashFound[1]+". Someone was planning to run. They didn't make it. Their loss, your gain.":"");}
      else if(ctx.indexOf('storm')>=0){actText="Rain hits like a wall. "+nm+" ducks under a concrete overhang and waits. The dead don't mind the rain ‚Äî but they can't hear as well in it. Small mercy.\n\nThe storm passes. The route to "+destName+" is muddier but passable.";}
      else if(ctx.indexOf('survivor')>=0){actText="Movement ahead. "+nm+" freezes, hand on weapon ‚Äî then a voice. Human. Shaking.\n\nA figure emerges from behind a dumpster near "+destName+". Wild eyes, cracked lips. They've been alone too long.";}
      else{actText=nm+" picks through the ruins toward "+destName+". Broken glass crunches underfoot. The street is a museum of the last normal day ‚Äî cars stopped mid-turn, a stroller on its side, a phone face-down in a puddle.\n\nThe route is clear. Unnervingly clear.";}
    }else if(ctx.indexOf('custom')>=0||ctx.indexOf('Player:')>=0){
      var action=ctx.replace(/Player: "/,'').replace(/".*$/,'').trim();
      actText=nm+" "+action.charAt(0).toLowerCase()+action.slice(1)+(action.endsWith('.')?'':'.')+"\n\n"+(suc?"It works ‚Äî barely. In this world, barely is enough.":"The attempt doesn't go as planned. But "+nm+" is still breathing, and that counts.");
    }else{
      if(suc)actText=nm+" pushes through the task. "+timeText+"\n\nIt works. Another small victory in a world that doesn't hand them out.";
      else actText="It doesn't work. "+nm+" grits their teeth and moves on. Failure is just another word for 'still learning.'\n\n"+timeText;
    }
  }

  // Compose final text with optional state layers
  var parts=[];
  if(actText){parts.push(actText)}
  else{parts.push(timeText);if(themeFlavor)parts.push(themeFlavor)}
  // Add a state layer if relevant (don't spam every turn)
  if(healthText&&Math.random()<0.5)parts.push(healthText);
  else if(resText&&Math.random()<0.5)parts.push(resText);
  else if(threatText&&Math.random()<0.3)parts.push(threatText);

  return showOfflineTag(parts.join("\n\n"));
}

function showOfflineTag(txt){
  if(offlineWarned)return txt;
  offlineWarned=true;
  if(aiStatus==='ready')return txt;
  var reason;
  if(RESTRICTED_ORIGIN)reason="Offline narrator active. AI narration available when hosted on HTTPS (GitHub Pages).";
  else reason="AI model not loaded. Download from ‚ò∞ INFO ‚Üí Log tab. Offline narrator active ‚Äî full gameplay available.";
  return txt+"\n\n[‚ö† "+reason+"]";
}

// ============================================================
// MAIN ACTION LOOP
// ============================================================
async function doOpening(){setLoad(true);var g=S.gs,ch=getLeader(),bg=BGS.find(function(b){return b.id===ch.background}),tc=g.themeConfig||{};var partyNames=getActiveParty().map(function(c){return c.name}).join(", ");var txt=await callAI("OPENING. "+ch.name+", former "+(bg?bg.name:"survivor")+", leads a group of "+getActiveParty().length+" ("+partyNames+") who just set up camp near "+g.locName+". Describe the world. Set the "+g.theme+" tone. Rules: "+(tc.rule||"")+". Make it unforgettable.");addNar(txt);setLoad(false)}

async function doAct(act){
  if(act.id==='travel'){showTravelUI();return}
  setLoad(true);
  var g=S.gs,ch=getCurrentActor(),dd=DIFFS.find(function(d){return d.id===g.diff})||DIFFS[1],roll=null,suc=null,ctx="";

  if(act.skill&&act.dc){
    var nat=rollD20(),sk=ch.skills[act.skill]||{rank:0,xp:0},ak=SMAP[act.skill]||"wits",am=getMod(ch.attrs[ak]||10),mod=sk.rank+am,tot=nat+mod,dc=act.dc+dd.dcMod;
    if(ch.morale<=0){tot-=2;mod-=2} // broken will penalty
    suc=nat===20||tot>=dc;if(nat===1)suc=false;
    roll={nat:nat,mod:mod,total:tot};
    var rankUp=awardXP(act.skill,suc);
    ctx+=' "'+act.label+'". '+act.skill+': '+nat+'+'+mod+'='+tot+' vs DC '+dc+'. '+(suc?'SUCCESS':'FAILURE')+'.';
    if(rankUp)ctx+=' [SKILL UP: '+act.skill+' rank '+rankUp+']';

    if(suc){
      if(act.id==="scavenge"){
        var curZone=g.zones.find(function(z){return z.id===g.currentZone});
        var scarMod=curZone&&curZone.scarcity<30?0.5:1;
        var loot=gLoot();loot.forEach(function(i){ch.inventory.push(i)});
        // Collect materials
        var mats=[];loot.forEach(function(i){if(i.mat&&g.base.materials[i.mat]!==undefined){g.base.materials[i.mat]++;mats.push(i.mat)}});
        ctx+=" Found: "+loot.map(function(i){return i.name}).join(", ")+".";
        if(mats.length)ctx+=" Materials: +"+mats.join(", +")+"."
        // Deplete zone scarcity
        if(curZone){curZone.scarcity=Math.max(0,curZone.scarcity-Math.floor(8*scarMod));if(curZone.scarcity<=0)ctx+=" This area is picked clean."}
        // Chance of combat
        if(Math.random()<0.2+g.threat*0.05){ctx+=" But you're not alone!";addRoll(act.label.replace(/[^\w\s]/g,'').trim(),roll,dc,suc);var txt=await callAI(ctx);addNar(txt);setLoad(false);startCombat(2+Math.floor(g.threat/2));advanceTurn();return}
      }else if(act.id==="scout"){
        var un=g.zones.filter(function(z){return z.status==="unexplored"}).slice(0,2);
        un.forEach(function(z){z.status="scouted"});
        if(un.length)ctx+=" Revealed: "+un.map(function(z){return z.name}).join(", ")+".";
        else ctx+=" All zones already scouted.";
      }else if(act.id==="fortify"){g.base.defense+=1;ctx+=" Defense now "+g.base.defense+"."}
    }else{
      if(act.id==="scavenge"){ch.stamina=Math.max(0,ch.stamina-1);ctx+=" Wasted effort. -1 stamina."}
    }
    addRoll(act.label.replace(/[^\w\s]/g,'').trim(),roll,dc,suc);
  }else if(act.id==="rest"){
    var healAmt=1+g.base.restHeal;
    ch.stamina=Math.min(ch.maxStamina,ch.stamina+2);ch.hp=Math.min(ch.maxHP,ch.hp+healAmt);
    ctx="Rested. +2 stamina, +"+healAmt+" HP.";
    // Chance of night attack
    if(g.timeOfDay==='night'&&Math.random()<0.15+g.threat*0.05){ctx+=" But something stirs in the dark...";var txt=await callAI(ctx);addNar(txt);setLoad(false);startCombat(1+g.threat);advanceTurn();return}
  }else{ctx='Player: "'+act.label+'". Narrate the attempt.'}

  advanceTurn();
  var txt=await callAI(ctx);addNar(txt);setLoad(false);
}

function advanceTurn(){
  var g=S.gs;
  // Advance to next party member's turn, or advance time if everyone acted
  g.currentActorIndex++;
  if(g.currentActorIndex<g.turnOrder.length){
    // More party members still need to act this round
    buildActs();
    return;
  }
  // All party members have acted ‚Äî advance time
  g.currentActorIndex=0;g.turnOrder=g.activePartyIds.slice();
  var times=["dawn","morning","afternoon","dusk","night"],idx=times.indexOf(g.timeOfDay);
  if(idx<times.length-1)g.timeOfDay=times[idx+1];
  else{g.day++;g.timeOfDay="dawn";dailyTick(g);getActiveParty().forEach(function(ch){ch.morale=Math.max(0,ch.morale-2)})}
  g.threat=Math.min(10,Math.floor(g.day/5));g.turns++;
  // Weather cycling
  var weathers=["clear","clear","clear","overcast","overcast","foggy","rain","rain","storm"];
  if(Math.random()<0.3)g.weather=pick(weathers);
  // Game over check (leader death)
  var leader=getLeader();
  if(leader&&leader.hp<=0){leader.hp=0;addNar("[üíÄ "+leader.name+" has died. Day "+g.day+". The apocalypse wins this round.]\n\n[Game Over ‚Äî Load a save or start over.]");setLoad(false);$('action-panel').style.display='none';updateHUD();renderSB();autoSave();return}
  if(leader&&leader.morale<=0){addNar("[üòî "+leader.name+"'s will to survive has broken. Morale has hit zero.]\n\n[You can keep playing, but every check is at -2.]")}
  updateHUD();renderSB();buildActs();autoSave();
}

function doCustom(){
  var v=$('custom-act').value.trim();if(!v)return;$('custom-act').value='';
  // Infer skill from custom action text
  var vl=v.toLowerCase(),sk="spot",dc=12;
  if(vl.match(/sneak|hide|stealth/)){sk="stealth";dc=13}
  else if(vl.match(/climb|jump|run|sprint/)){sk="athletics";dc=11}
  else if(vl.match(/search|loot|scavenge|look/)){sk="search";dc=12}
  else if(vl.match(/talk|persuade|convince|negotiate/)){sk="persuasion";dc=13}
  else if(vl.match(/fix|repair|build|craft/)){sk="craft_struct";dc=12}
  else if(vl.match(/shoot|aim|fire|throw/)){sk="ranged";dc=13}
  else if(vl.match(/fight|attack|hit|punch|stab/)){sk="melee";dc=12}
  else if(vl.match(/heal|bandage|treat|medicine/)){sk="first_aid";dc=11}
  else if(vl.match(/listen|watch|observe/)){sk="spot";dc=10}
  doAct({id:"custom",label:v,skill:sk,dc:dc});
}

// ============================================================
// DIALOGS & MENUS
// ============================================================
function showConfirm(msg,body,onYes){$('confirm-msg').textContent=msg;$('confirm-body').innerHTML=body||'';$('confirm-yes').onclick=function(){hideConfirm();onYes()};$('confirm-dialog').style.display='flex'}
function hideConfirm(){$('confirm-dialog').style.display='none'}
function showMsg(msg){showConfirm(msg,'',function(){})}
function confirmReset(){showConfirm('Return to title screen?','Unsaved progress will be lost.',function(){location.reload()})}

function showSaveMenu(){
  var saves=getSaves();
  var h='';
  for(var i=1;i<=3;i++){
    var s=saves['slot'+i];
    h+='<div class="save-slot'+(s?' has-data':'')+'" style="text-align:left">';
    h+='<div style="display:flex;justify-content:space-between;align-items:center"><strong>Slot '+i+'</strong>';
    if(s)h+='<span class="dim" style="font-size:10px">'+timeAgo(s.ts)+'</span>';
    h+='</div>';
    if(s)h+='<div class="dim" style="font-size:11px">'+s.name+'</div>';
    else h+='<div class="dim" style="font-size:11px">Empty</div>';
    h+='<div style="display:flex;gap:4px;margin-top:6px">';
    h+='<button class="debug-btn" style="background:var(--accent-green)" onclick="hideConfirm();saveToSlot(\'slot'+i+'\');showMsg(\'Saved to Slot '+i+'!\')">SAVE</button>';
    if(s)h+='<button class="debug-btn" style="background:var(--accent-blue)" onclick="hideConfirm();if(loadFromSlot(\'slot'+i+'\')){go(\'game\');initGameUI()}">LOAD</button>';
    h+='</div></div>';
  }
  h+='<div style="margin-top:12px;display:flex;gap:4px"><button class="debug-btn" style="background:var(--accent-amber)" onclick="hideConfirm();exportSave()">üì§ Export JSON</button></div>';
  showConfirm('üíæ Save / Load',h,function(){});
}

function showLoadScreen(){
  var saves=getSaves();var autos=getAutosaves();
  var h='';
  for(var i=1;i<=3;i++){var s=saves['slot'+i];if(s){h+='<div class="save-slot has-data" onclick="if(loadFromSlot(\'slot'+i+'\')){hideConfirm();go(\'game\');initGameUI()}"><strong>Slot '+i+'</strong> ‚Äî '+s.name+'<div class="dim" style="font-size:10px">'+timeAgo(s.ts)+'</div></div>'}}
  if(autos.length){h+='<div class="save-slot has-data" onclick="S.gs=validateGameState(getAutosaves()[0].state);hideConfirm();go(\'game\');initGameUI()"><strong>Autosave</strong><div class="dim" style="font-size:10px">Turn '+autos[0].turn+' ‚Äî '+timeAgo(autos[0].ts)+'</div></div>'}
  if(!h)h='<div class="dim" style="text-align:center;padding:20px">No saves found.</div>';
  showConfirm('üìÇ Load Game',h,function(){});
}

function showImportDialog(){
  var h='<textarea class="input" id="import-json" placeholder="Paste save JSON here..." style="height:100px;font-size:11px;font-family:monospace;resize:vertical"></textarea>';
  h+='<div style="margin-top:8px"><button class="btn btn-sm" onclick="var j=$(\'import-json\').value.trim();if(j&&importSave(j))hideConfirm()">IMPORT</button></div>';
  showConfirm('üìã Import Save',h,function(){});
}

// ============================================================
// DEBUG PANEL
// ============================================================
function toggleDebug(){debugOpen=!debugOpen;$('debug-panel').classList.toggle('open',debugOpen)}
function dbgLog(msg){var el=$('debug-log');el.textContent='['+new Date().toLocaleTimeString()+'] '+msg+'\n'+el.textContent;el.textContent=el.textContent.substring(0,2000)}
function dbgSetDay(){if(!S.gs)return;var v=prompt('Set day:',S.gs.day);if(v){S.gs.day=parseInt(v)||1;updateHUD();dbgLog('Day set to '+S.gs.day)}}
function dbgSetThreat(){if(!S.gs)return;var v=prompt('Set threat:',S.gs.threat);if(v!==null){S.gs.threat=parseInt(v)||0;updateHUD();dbgLog('Threat set to '+S.gs.threat)}}
function dbgSpawnItem(){if(!S.gs)return;var loot=gLoot();var ch=getLeader();loot.forEach(function(i){ch.inventory.push(i)});addNar("[DEBUG] Spawned: "+loot.map(function(i){return i.name}).join(", "));renderSB()}
function dbgForceCombat(){if(!S.gs)return;startCombat(3)}
function dbgHeal(){if(!S.gs)return;getAliveRoster().forEach(function(ch){ch.hp=ch.maxHP;ch.stamina=ch.maxStamina;ch.morale=100});addNar("[DEBUG] Full heal ‚Äî all survivors.");updateHUD();renderSB()}
function dbgAddResources(){if(!S.gs)return;S.gs.base.food+=10;S.gs.base.water+=10;S.gs.base.medical+=5;Object.keys(S.gs.base.materials).forEach(function(m){S.gs.base.materials[m]+=10});addNar("[DEBUG] Resources added.");renderSB()}
function dbgPrintState(){if(!S.gs)return;dbgLog(JSON.stringify(S.gs,null,1).substring(0,1500))}
function dbgClearSaves(){localStorage.removeItem(SAVE_KEY);localStorage.removeItem(AUTOSAVE_KEY);dbgLog('All saves cleared.');showMsg('Saves cleared.')}

// ============================================================
// PWA INSTALL
// ============================================================
window.addEventListener('beforeinstallprompt',function(e){e.preventDefault();deferredInstallPrompt=e;$('install-btn').style.display='inline-block'});
function installPWA(){if(deferredInstallPrompt){deferredInstallPrompt.prompt();deferredInstallPrompt.userChoice.then(function(r){deferredInstallPrompt=null;if(r.outcome==='accepted')showMsg('App installed!')})}}

// ============================================================
// INIT
// ============================================================
loadSettings();
if(hasSaves())$('continue-btn').style.display='inline-block';

// Register minimal service worker for PWA
if('serviceWorker' in navigator){
  var swCode='self.addEventListener("install",function(e){self.skipWaiting()});self.addEventListener("fetch",function(e){e.respondWith(fetch(e.request).catch(function(){return new Response("Offline")}))})';
  var swBlob=new Blob([swCode],{type:'application/javascript'});
  navigator.serviceWorker.register(URL.createObjectURL(swBlob)).catch(function(){});
}

// Keyboard shortcuts
document.addEventListener('keydown',function(e){
  if(e.key==='Enter'){if(document.activeElement===$('custom-act'))doCustom();if(document.activeElement===$('loc-input'))locSearch()}
  if(e.key==='Escape'){if(inCombat)return;if($('confirm-dialog').style.display==='flex')hideConfirm();if(debugOpen)toggleDebug()}
});
</script></body></html>
